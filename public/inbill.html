<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>In Bill | Coffee & Beer GooDjn</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #fafbfc;
      color: #23272f;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #fafbfc;
    }
    #navbar-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      z-index: 10000;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
    }
    .site-content {
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      padding-top: 30px;
      padding-bottom: 50px;
      align-items: center;
    }
    #footer-container {
      background: #228B22;
      color: #fff;
      width: 100vw;
      min-height: 54px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      box-sizing: border-box;
      text-align: center;
      padding: 0 10px;
      position: fixed;
      left: 0;
      bottom: 0;
      z-index: 999;
    }
    #footer-container div {
      width: 100%;
      text-align: center;
      line-height: 1.15;
      word-break: break-word;
    }
    .bill-panel {
      width: 100%; max-width: 410px; margin: 0 auto 80px auto; margin-top: 22px;
      background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 16px 0 22px 0; display: flex; flex-direction: column; align-items: center;
    }
    .bill-header {
      display: flex; align-items: center; justify-content: flex-start; gap: 10px; margin-bottom: 14px;
      width: 100%; padding: 0 20px; font-size: 1em; font-weight: 500; border: 1.5px solid #e1e6ed;
      border-radius: 10px; background: #f6f7fb; height: 48px; box-sizing: border-box;
    }
    .bill-header label { font-weight: 500; color: #155fa0; margin-right: 3px; font-size: 1em; }
    #bill-order-code {
      width: 68px; font-size: 1em; text-align: center; border: 1.2px solid #c3c8d2; border-radius: 5px;
      padding: 5px 9px; transition: border-color 0.2s; outline: none;
    }
    #bill-order-code:focus { border-color: #1d5ecd; }
    .header-btn {
      display: flex; align-items: center; gap: 4px; font-weight: 500; border: none; border-radius: 6px;
      padding: 6px 15px; font-size: 0.98em; cursor: pointer; transition: background 0.18s, box-shadow 0.13s;
      outline: none; box-shadow: 0 1px 2px rgba(0,0,0,0.04); min-width: 0;
    }
    #bill-search-btn.header-btn {
      background: linear-gradient(to bottom, #36c16a, #219a50); color: #fff; font-weight: 600;
    }
    #bill-search-btn.header-btn:hover { background: linear-gradient(to bottom, #219a50, #36c16a);}
    #bill-print-btn.header-btn {
      background: linear-gradient(to bottom, #4f80e1, #1d5ecd); color: #fff; font-weight: 600;
    }
    #bill-print-btn.header-btn:disabled {
      opacity: 0.55; background: #bfcbe8; color: #fff; cursor: not-allowed;
    }
    #bill-print-btn.header-btn:hover:not(:disabled) { background: linear-gradient(to bottom, #1d5ecd, #4f80e1);}
    #bill-reset-btn.header-btn {
      background: linear-gradient(to bottom, #f47373, #e53935); color: #fff; font-weight: 600; padding: 6px 12px;
    }
    #bill-reset-btn.header-btn:hover { background: linear-gradient(to bottom, #e53935, #f47373);}
    #bill-status-note {
      margin-top: 4px; margin-bottom: 8px; font-size: 1.03em; width: 100%; text-align: left; padding-left: 27px;
      min-height: 20px; display: flex; align-items: center; gap: 7px;
    }
    .bill-status-paid {
      color: #219a50; font-weight: 600; display: flex; align-items: center; gap: 5px;
    }
    .bill-status-unpaid {
      color: #e53935; font-weight: 600; display: flex; align-items: center; gap: 5px;
    }
    .bill-print-wrapper {
      width: 100%; max-width: 330px; margin: 0 auto; background: #fff; border: 1.2px solid #cddc39; border-radius: 10px;
      padding: 12px 17px 15px 17px; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 1em; margin-top: 2px; box-shadow: 0 1.5px 5px rgba(0,0,0,0.06);
    }
    .bill-logo-title {
      color: #08810a; font-weight: 700; font-size: 1.08em; text-align: center; margin-bottom: 0px; margin-top: 2px;
      letter-spacing: 0.02em; font-family: 'Segoe UI Semibold', 'Segoe UI', Arial, sans-serif; text-transform: uppercase; letter-spacing: 0.07em;
    }
    .bill-addr { color: #434343; font-size: 0.97em; text-align: center; margin-bottom: 0px; line-height: 1.17; font-family: 'Segoe UI', Arial, sans-serif;}
    .bill-phone { text-align: center; color: #1762a8; font-size: 0.96em; margin-bottom: 4px; margin-top: 0px; font-family: 'Segoe UI', Arial, sans-serif; letter-spacing: 0.01em;}
    .bill-title-main {
      color: #1a237e; font-weight: 700; font-size: 1.16em; text-align: center; margin-top: 7px; margin-bottom: 9px;
      letter-spacing: 0.4px; font-family: 'Segoe UI Semibold', 'Segoe UI', Arial, sans-serif;
    }
    .bill-info-row { display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 0.95em; }
    .bill-section-title { font-weight: 600; color: #1d5ecd; margin-top: 8px; margin-bottom: 2px; font-size: 1em; }
    .bill-section { border-top: 1px solid #bbb; padding-top: 7px; margin-top: 8px; margin-bottom: 2px;}
    .bill-table { width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 0.97em; }
    .bill-table th, .bill-table td { border: none; padding: 4px 2px 2px 2px; text-align: left; }
    .bill-table th { color: #1d5ecd; font-weight: 600; font-size: 1em; border-bottom: 1px solid #bbb; background: #f7faff; letter-spacing: 0.01em; }
    .bill-table td { font-size: 0.96em; }
    .bill-table .td-num, .bill-table .td-price, .bill-table .td-total { text-align: right; }
    .bill-total-row { border-top: 1.5px solid #333; font-weight: 700; color: #155724; font-size: 1.06em; background: #f4ffe6; }
    .bill-customer-thank {
      color: #08810a; font-size: 1em; font-weight: 600; text-align: center; margin-top: 7px; margin-bottom: 0; letter-spacing: 0.01em;
    }
    .main-flex-container {
      display: flex; justify-content: center; align-items: flex-start; width: 100%; max-width: 1200px;
      margin: 0 auto; gap: 32px; padding: 24px 0 0 0; min-height: 600px; box-sizing: border-box;
    }
    .order-list-title {
      text-align: center; font-size: 1.45em; font-weight: 800; color: #14a904f4; margin-bottom: 18px;
      letter-spacing: 0.01em; text-shadow: 0 1px 6px #e1f0fe;
    }
    .order-list-panel {
      position: relative;
      background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.09);
      padding: 26px 42px 28px 42px; width: 100%;
      min-width: 950px; max-width: 1100px; margin-top: 24px; font-size: 1.03em; box-sizing: border-box;
    }
    .order-list-table {
      width: 100%; border-collapse: separate; border-spacing: 0; background: #fcfcfc; margin-bottom: 8px;min-width: 850px;
    }
    .order-list-table th, .order-list-table td { padding: 5px 6px; font-size: 1em; }
    .order-list-table th { background: #e8f2ff; font-weight: 600; color: #1663b1; font-size: 0.9em; }
    .order-list-table tr:nth-child(even) td { background: #f8fbff; }
    .order-list-table tr:hover td { background: #a6f5e5; }
    .order-list-table td { font-size: 0.9em; max-height: 32px; }
    .order-status-btn, .order-status-paid {
      padding: 6px 16px;
      min-width: 140px;
      font-size: 1em;
      line-height: 1.2;
      border: none;
      border-radius: 8px;
      display: inline-block;
      text-align: center;
      box-sizing: border-box;
      font-weight: 500;
      height: 30px;
    }
    .order-status-btn { background: #e20808; color: #fff; cursor: pointer; transition: background 0.15s; }
    .order-status-btn:hover { background: #9e2323; }
    .order-status-paid { background: #0cac11; color: #fff; cursor: default; cursor: pointer;}
    .order-status-paid:hover {
    background: #0b7d1e; /* Xanh lá cây đậm hơn khi hover */
    }
   .order-edit-btn {
      background: #2196f3; color: #fff; border: none; border-radius: 6px; padding: 5px 14px;
      font-weight: bold; cursor: pointer; transition: background 0.13s;
    }
    .order-edit-btn:hover { background: #156ab7; }
    .order-pagination-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      position: relative;
    }
    .order-entries-select {
      font-size: 1em; padding: 2px 5px; border-radius: 4px; border: 1px solid #b5c8db;
    }
    .order-pagination {
      display: flex;
      gap: 2px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin: 16px auto 0 auto;
    }
    .order-pagination button, .order-pagination span {
      min-width: 32px; padding: 5px 7px; border: none; background: none; color: #1976d2; font-weight: 500;
      border-radius: 5px; cursor: pointer; font-size: 1em;
    }
    .order-pagination .active { background: #2196f3; color: #fff; font-weight: bold; pointer-events: none; }
    .order-pagination button:disabled { color: #bbb; background: #f1f1f1; pointer-events: none; }
    .order-search-box {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #order-search-input {
      height: 26px;
      min-width: 100px;
      width: 140px;
      font-size: 0.96em;
      padding: 2px 7px;
      border: 2px solid #2ecc40;
      border-radius: 6px;
      outline: none;
      transition: border .16s;
    }
    #order-search-input:focus { border-color: #1663b1;}
    #order-search-clear {
      height: 26px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      padding: 0 7px;
      cursor: pointer;
      transition: background 0.14s;
      margin-left: 2px;
    }
    #order-search-clear:hover { background: #a72816; }
    /* Popup modal nút xác nhận in bill và sửa đơn hàng */
    #customModal, #orderEditModal { 
      position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:11111;
      display:flex; align-items:center; justify-content:center;
      background: transparent;
    }
    .custom-modal-backdrop {
      position:absolute; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18);
      z-index: 1;
    }
    .custom-modal-box, .order-edit-modal-box {
      position:relative; z-index:2;
      background:#fff; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,0.15);
      max-width:94vw; width:410px; padding:32px 22px 20px 22px;
      text-align:center; font-size:1.13em; color:#133;
      animation: popFadeIn .23s;
    }
    #customModal > div {
  margin: 0 auto;
}
    @keyframes popFadeIn { from { opacity:0; transform:scale(0.96);} to { opacity:1; transform:scale(1);} }
@media print {
  body * { visibility: hidden !important; }
  .bill-print-wrapper, .bill-print-wrapper * { 
    visibility: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .bill-print-wrapper {
    position: absolute;
    left: 0; top: 0;
    width: 58mm !important;
    min-width: 58mm !important;
    max-width: 58mm !important;
    padding: 0 !important;
    margin: 0 auto !important;
    border: none !important;
    box-shadow: none !important;
    background: #fff !important;
  }
  .bill-logo-title {
    font-weight: bold;
    color: #15a138;
    font-size: 16px;
    text-align: center;
    margin-bottom: 2px;
  }
  .bill-title-main {
    color: #0047bb;
    font-weight: bold;
    font-size: 15px;
    margin-bottom: 6px;
    text-align: center;
  }
  .bill-addr, .bill-phone {
    text-align: center;
    font-size: 12px;
    margin-bottom: 2px;
  }
  .bill-info-row, .bill-section-title {
    width: 100%;
    font-size: 12px;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: space-between;
  }
  .bill-section-title {
    font-weight: 600;
    color: #0047bb;
    margin: 6px 0 2px 0;
    font-size: 13px;
  }
  .bill-table {
    width: 100% !important;
    border-collapse: collapse !important;
    text-align: center;
    font-size: 12px;
    margin: 6px 0;
  }
  .bill-table th, .bill-table td {
    border: 1px solid #bbb;
    padding: 2px 0;
    font-size: 12px;
    text-align: center !important;
  }
  .bill-table th {
    text-align: center !important;
    font-weight: 600;
    background: #f4f4f4;
    font-size: 12px;
    padding: 2px 0;
  }
  .bill-table thead tr {
    text-align: center !important;
  }
  .bill-table td {
    font-weight: 400;
  } 
  .bill-table td:nth-child(1),
  .bill-table td:nth-child(2),
  .bill-table td:nth-child(3) {
  text-align: center !important;
  }
  .bill-table td:nth-child(4) {
    text-align: right !important;
  }
  hr {
    width: 100% !important;
    border: none;
    border-top: 1px dashed #222 !important;
    margin: 6px 0 !important;
  }
  .bill-info-row span {
    display: inline-block;
    min-width: 30px;
    max-width: 58%;
    text-align: right;
  }
  .bill-info-row span:first-child {
    text-align: left;
    font-weight: 400;
  }
  .bill-info-row span:last-child {
    text-align: right;
    font-weight: 600;
  }
  .bill-customer-thank {
    color: #15a138;
    font-weight: bold;
    text-align: center;
    margin-top: 10px !important;
    font-size: 8px !important;    /* Giảm size xuống nhỏ hơn */
    line-height: 1.35 !important;
    word-break: break-word;
  }
  .bill-thank-shop {  
    display: block;
    font-size: 8px !important;
    margin-top: 2px;
    font-weight: bold;
  }
  /* Ẩn navbar, footer, popup khi in */
  #navbar-container, #footer-container, .modal, #orderEditModal, #thankModal {
    display: none !important;
  }
}
  /* Popup chỉnh classic style */

.order-edit-modal-box .modal-title {
  color: #1048c4;
  font-size: 1.2em;
  font-weight: 700;
  text-align: center;
  margin-bottom: 3px;
  margin-top: 6px;
  letter-spacing: 0.02em;
}
.order-edit-modal-box .order-code {
  color: #15a138;
  font-size: 1em;
  font-weight: 600;
  text-align: center;
}
.order-edit-modal-box .order-status {
  color: #e53935;
  font-size: 0.95em;
  font-weight: 600;
  text-align: center;
  margin-bottom: 3px;
}
.order-edit-modal-box .divider {
  border: 0;
  border-top: 1.5px dashed #bbb;
  margin: 10px 0;
}
.order-edit-modal-box .form-row {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
}
.order-edit-modal-box .form-label {
  flex: 0 0 120px;      /* hoặc 110-130 tuỳ độ dài */
  font-weight: 400;     /* Để font bình thường */
  font-size: 0.9em;       /* Nhỏ lại */
  color: #222;          /* Nhạt màu một chút */
  margin-right: 8px;
  text-align: left;     /* Đảm bảo luôn canh trái */
  line-height: 1.55;    /* Giúp hàng đều */
}
.order-edit-modal-box .form-input {
  flex: 1;
  font-size: 0.9em;
  padding: 4px 8px;
  border: 1px solid #b4b4b4;
  border-radius: 0;
  outline: none;
}
.order-edit-modal-box .staff-list-table input {
  text-align: center;   /* <-- Canh giữa chữ trong input */
  width: 100%;
  box-sizing: border-box;
  border: none;      /* Nếu muốn không viền, hoặc dùng border cho td */
  padding: 0 1px;    /* Có thể dùng padding nhỏ hoặc để 0 */
  height: 100%;      /* Nếu dòng bị thấp, có thể điều chỉnh thêm line-height cho td */
  font-size: 1em;    /* tuỳ chỉnh */
  background: transparent; /* Nếu muốn nền trong suốt */
  margin: 0;
}
.order-edit-modal-box textarea.form-input {
  min-height: 28px;
}
.order-edit-modal-box .nv-table-row {
  display: flex;
  align-items: center;
  gap: 2px;
  margin-bottom: 7px;
  margin-top: 10px;
}
.order-edit-modal-box .nv-table-title {
  font-size: 0.9em;
  font-weight: bold;
  color: #1673e7;
  margin-right: 10px;
  white-space: nowrap;
  line-height: 2;
}
.order-edit-modal-box .btn-them-nv {
  background: #16b311;
  color: #fff;
  border: none;
  border-radius: 4px;
  font-size: 0.9em;
  font-weight: 600;
  padding: 5px 15px;
  margin-bottom: 7px;
  margin-left: 15px;
  cursor: pointer;
  transition: background 0.15s;
}
.order-edit-modal-box .btn-them-nv:hover { background: #11990d; }
.order-edit-modal-box .staff-list-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 0;
  background: #fff;
}
.order-edit-modal-box .staff-list-table th,
.order-edit-modal-box .staff-list-table td {
  border: 1px solid #a8a8a8;
  text-align: center;
  font-size: 0.8em;
  padding:  0;
  background: #fff;
}
.order-edit-modal-box .staff-list-table th {
  background: #eafce4;
  color: #27a33d;
  font-weight: 700;
  padding: 5px 2px; 
}
.order-edit-modal-box .staff-list-table th:nth-child(1),
.order-edit-modal-box .staff-list-table td:nth-child(1) { width: 10px; }
.order-edit-modal-box .staff-list-table th:nth-child(2),
.order-edit-modal-box .staff-list-table td:nth-child(2) { width: 10px; }
.order-edit-modal-box .staff-list-table th:nth-child(3),
.order-edit-modal-box .staff-list-table td:nth-child(3) { width: 100px; }
.order-edit-modal-box .staff-list-table th:nth-child(4),
.order-edit-modal-box .staff-list-table td:nth-child(4) { width: 100px; }
.order-edit-modal-box .staff-list-table th:nth-child(5),
.order-edit-modal-box .staff-list-table td:nth-child(5) { width: 20px; }

.order-edit-modal-box .btn-xoa-nv {
      background: #e53935;
      color: #fff;
      border: none;
      min-width: 48px;
      padding: 3px 8px;
      font-size: 0.96em;
      border-radius: 4px;
      font-weight: 600;
      margin: 2px auto;      /* Thêm margin trên/dưới để nút không dính sát viền cell */
      display: block;
      transition: background 0.18s;
}
.order-edit-modal-box .btn-xoa-nv:hover { background: #c62828; }

.order-edit-modal-box .total-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0;
  font-size: 1.07em;
}
.order-edit-modal-box .total-table td {
  border: none;
  padding: 2px 10px 2px 0;
  font-weight: 600;
}
.order-edit-modal-box .total-row {
  color: #13ad2f;
  font-size: 0.9em;      /* hoặc font-size lớn hơn mặc định */
  font-weight: 700;
}
.order-edit-modal-box .giamgia-row td {
  color: #1547ad;
  font-weight: 500;
  font-size: 0.9em;
}
.order-edit-modal-box .tongthu-row td {
  color: #c00;
  font-weight: 700;
  font-size: 0.9em;
}

.order-edit-modal-box .edit-modal-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 16px;
  margin-bottom: 0;
  padding: 8px 0 4px 0;
  background: #fff;
}
.order-edit-modal-box .btn-save {
  background: #19b118;
  color: #fff;
  border: none;
  border-radius: 5px;
  font-weight: 600;
  font-size: 0.9em;              /* nhỏ lại */
  padding: 5px 20px;           /* nhỏ lại */
  min-width: 70px;             /* nhỏ lại */
  cursor: pointer;
  transition: background 0.18s;
  margin: 0 4px;
}
.order-edit-modal-box .btn-save:hover { background: #10900f; }
.order-edit-modal-box .btn-cancel {
  background: #e53935;
  color: #fff;
  border: none;
  border-radius: 5px;
  font-weight: 600;
  font-size: 0.9em;              /* nhỏ lại */
  padding: 5px 20px;           /* nhỏ lại */
  min-width: 70px;             /* nhỏ lại */
  cursor: pointer;
  transition: background 0.18s;
  margin: 0 4px;
}
.order-edit-modal-box .btn-cancel:hover { background: #c62828; }
.order-edit-modal-box #edit-tongCong {
  color: #16a220;
  font-size: 0.9em !important;
  font-weight: bold;
  text-align: right;
}

.order-edit-modal-box #edit-tongThu {
  color: #c00;
  font-size: 0.9em !important;
  font-weight: bold;
  text-align: right;
}

.order-edit-modal-box #edit-giamGia {
  color: #1547ad;
  font-size: 0.9em !important;
  font-weight: 500;
  text-align: right;
}
.order-edit-modal-box .modal-close-btn {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 2em;
  color: #c00;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 3;
  padding: 0 8px;
  line-height: 1;
  font-weight: bold;
  transition: color 0.2s;
}
.order-edit-modal-box .modal-close-btn:hover {
  color: #fff;
  background: #e53935;
  border-radius: 50%;
}

#deleteStaffModal.modal {
  display: none;
  position: fixed;
  z-index: 13000 !important;
  left: 0; top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(60,70,80,0.18);
  /* Chỉ căn giữa khi có class show */
}
#deleteStaffModal.show {
  display: flex !important;
  align-items: center;
  justify-content: center;
}
.delete-staff-modal-dialog {
  width: 100%;
  max-width: 350px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}
.delete-staff-modal-content {
  background: #f8fafc;
  border-radius: 10px;
  box-shadow: 0 7px 28px rgba(34,60,80,0.16);
  border: 1.5px solid #cfe2e8;
  padding: 21px 20px 16px 20px;
  width: 100%;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.delete-staff-modal-title {
  font-size: 1.08em;
  font-weight: 500;
  color: #091379;
  text-align: center;
  margin-bottom: 18px;
  line-height: 1.3;
}
.delete-staff-modal-actions {
  display: flex;
  justify-content: center;
  gap: 14px;
  width: 100%;
}
.delete-staff-btn-confirm,
.delete-staff-btn-cancel {
  padding: 6px 20px;
  min-width: 0;
  font-size: 1em;
  font-weight: 600;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
  box-shadow: none;
  outline: none;
  /* Giảm chiều cao và chiều dài nút */
  min-width: 54px;
}
.delete-staff-btn-confirm {
  background: #0cac14;
  color: #fff;
}
.delete-staff-btn-confirm:hover {
  background: #189b11;
}
.delete-staff-btn-cancel {
  background: #e91b0d;
  color: #ffffff;
}
.delete-staff-btn-cancel:hover {
  background: #c50909;
  color: #ffffff;
}
@media (min-width: 768px) {
  .order-list-table {
    table-layout: auto !important;   /* BỎ fixed, chuyển lại auto */
    width: 100%;
  }
  .order-list-table th, .order-list-table td {
    white-space: nowrap;      /* Mặc định là không xuống dòng (ngắn gọn) */
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
    max-width: unset;
  }
  /* CHỈ cột dài mới ép xuống dòng */
  .order-list-table td.ten-khach-hang,
  .order-list-table td.ma-nv {
    white-space: normal !important;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 150px;   /* hoặc 120-170px tuỳ ý */
  }
}
/* Popup Đã lưu thành công */
#thankModal {
  position: fixed;
  inset: 0;
  z-index: 12000;
  display: none; /* Mặc định ẩn */
  align-items: center;         /* Canh giữa dọc */
  justify-content: center;     /* Canh giữa ngang */
  background: rgba(0,0,0,0.25); /* overlay nền mờ */
}
#thankModal.show {
  display: flex !important;    /* Hiện popup khi có class show */
}
#thankModal .popup-thank {
  background: #e1f1fb;
  border-radius: 12px;
  box-shadow: 0 2px 14px rgba(0,0,0,0.13);
  padding: 26px 36px 22px 36px;
  min-width: 220px;
  max-width: 340px;          /* Vừa nội dung, không quá rộng */
  margin: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#thankModal .popup-thank .title {
  font-size: 1.13em;
  font-weight: 600;
  color: #0e3f8f;
  margin-bottom: 14px;
  line-height: 1.3;
}
#thankModal .popup-thank .btn-back {
  margin-top: 10px;
  padding: 7px 22px;
  background: #03a9f4;
  color: #fff;
  border: none;
  border-radius: 7px;
  cursor: pointer;
  font-size: 1em;
  font-weight: 500;
  transition: background 0.2s;
}
#thankModal .popup-thank .btn-back:hover {
  background: #0288d1;
}
/* phần CSS popup sau khi in customModal*/
#customModal button {
  font-size:1em; 
  padding:8px 22px; 
  border-radius:8px; 
  border:none !important;
  font-weight:600;
  margin: 0 10px;
  box-shadow: none !important;
  outline: none !important;
  color: #fff !important;
  background: #888 !important; 
  background-color: #888 !important;
  cursor:pointer !important;
  filter: none !important;
  opacity: 1 !important;
  transition: background .15s, filter .13s, opacity .13s;
}

/* Nút OK xanh lá */
#customModal .btn-ok:not(:disabled) {
  background: #29b858 !important;
  background-color: #29b858 !important;
  color: #fff !important;
  border: none !important;
  filter: none !important;
  opacity: 1 !important;
}
#customModal .btn-ok:hover:not(:disabled), #customModal .btn-ok:focus:not(:disabled) {
  background: #179b40 !important;
  background-color: #179b40 !important;
  color: #fff !important;
  filter: brightness(1.04);
}

/* Nút Cancel xanh nước biển */
#customModal .btn-cancel:not(:disabled) {
  background: #2696f8 !important;
  background-color: #2696f8 !important;
  color: #fff !important;
  border: none !important;
  filter: none !important;
  opacity: 1 !important;
}
#customModal .btn-cancel:hover:not(:disabled), #customModal .btn-cancel:focus:not(:disabled) {
  background: #156baf !important;
  background-color: #156baf !important;
  color: #fff !important;
  filter: brightness(1.04);
}

/* Trạng thái disabled: màu nền vẫn đúng, chữ vẫn trắng, hiệu ứng nhạt màu */
#customModal button:disabled,
#customModal .btn-ok:disabled,
#customModal .btn-cancel:disabled {
  background: #aaa !important;
  background-color: #aaa !important;
  color: #fff !important;
  opacity: 0.6 !important;
  border: none !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
  filter: grayscale(0.18) brightness(1.04) !important;
}
/* phủ mờ popup khi đang lưu */
.edit-modal-overlay {
  position: fixed;  
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(200, 200, 200, 0.55);
  z-index: 2000;
  display: none;
  cursor: wait;
}
#orderEditModal {
  left: 0; top: 0; width: 100vw; min-height: 100vh;
  z-index: 1999;
  display: block;
}
.modal-content.order-edit-modal-box {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 0 20px rgb(2, 163, 18);
  border: 2px solid #14b55f;
  max-width: 100%;
  width: 100%;
  padding: 12px 20px 18px 20px;
  box-sizing: border-box;
  position: relative;
  font-family: Arial, Helvetica, sans-serif;
}
.modal {
  display: none;
  z-index: 12000 !important;
  width: 100vw;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  background: rgba(0,0,0,0.2);
}
.modal.show {
  display: block !important;
}
#orderEditModal .modal-dialog {
  margin: 200px auto 60px auto;
  max-width: 470px;
  width: 96vw;
  min-width: 320px;
}

.modal-content {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  border: none;
  overflow: hidden;
  width: 100%; /* Đảm bảo chiều rộng tự động điều chỉnh */
}

.modal-body {
  padding: 0;
}
/* Cho phép cột Thời gian xuống dòng như tên khách hàng */
.order-list-table td.thoi-gian, .order-list-table th.thoi-gian {
  white-space: normal !important;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 150px; /* hoặc tuỳ chỉnh theo giao diện */
}
.wake-btn-absolute {
  position: absolute;
  top: 18px;           /* chỉnh lên/xuống theo ý */
  right: 20px;         /* chỉnh sát/xa biên phải */
  background: #ffb300;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 7px;
  padding: 4px 12px;
  font-size: 1em;
  cursor: pointer;
  z-index: 10;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
}
.wake-btn-absolute i {
  margin-right: 6px;
  font-size: 1.1em;
}
</style>
</head>
<body>`
  <!-- NAVBAR -->
  <div id="navbar-container">
    <div class="desktop-navbar"></div>
  </div>
  <div class="site-content">
    <div class="main-flex-container">
      <div class="order-list-panel">
        <button id="wake-btn" class="wake-btn-absolute" title="Làm mới dữ liệu">
          <i class="fa fa-bolt"></i> Đánh thức
        </button>
        <div class="order-list-title">Danh sách đơn hàng</div>
        <div class="order-pagination-container">
          <div>
            Hiển thị 
            <select id="order-entries-select" class="order-entries-select">
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            đơn hàng
          </div>
          <div class="order-search-box">
            <input id="order-search-input" type="text" placeholder="Tìm kiếm..." autocomplete="off">
            <button id="order-search-clear" title="Xóa tìm"><i class="fa fa-times"></i></button>
          </div>
        </div>
        <table class="order-list-table" id="order-list-table">
          <thead>
            <tr>
              <th style="width: 42px;">Stt</th>
              <th style="width: 150px;">Thời gian</th>
              <th style="width: 70px;">Số đơn</th>
              <th class="ten-khach-hang" style="width: 18%;">Tên khách hàng</th>
              <th style="width: 60px;">Thẻ bàn số</th>
              <th class="ma-nv" style="width: 210px;">Mã NV</th>
              <th style="width: 110px;">Tổng tiền</th>
              <th style="width: 155px;">Xác nhận</th>
              <th style="width: 90px;">Sửa ĐH</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="8" style="text-align:center;color:#888;">Đang tải...</td></tr>
          </tbody>
        </table>
        <div id="order-pagination" class="order-pagination"></div>
      </div>
      <div class="bill-panel">
        <div class="bill-header">
          <label for="bill-order-code">Số phiếu</label>
          <input id="bill-order-code" type="text" maxlength="8" autocomplete="off" placeholder="..." />
          <button id="bill-search-btn" class="header-btn" title="Tìm kiếm"><i class="fa fa-search"></i><span class="d-none d-sm-inline">Tìm kiếm</span></button>
          <button id="bill-print-btn" class="header-btn" disabled title="In bill"><i class="fa fa-print"></i><span class="d-none d-sm-inline">In Bill</span></button>
          <button id="bill-reset-btn" class="header-btn" title="Xóa bill"><i class="fa fa-trash"></i></button>
        </div>
        <div id="bill-status-note"></div>
        <div id="bill-print-area" class="bill-print-wrapper"></div>
      </div>
    </div>
    <div id="footer-container">
      <div>
        &copy; 2025 <b>Coffee & Beer DJ GooDjn</b>. All rights reserved.<br>
        63-65 Ngô Quyền, Phường 6, Quận 10, Hồ Chí Minh
      </div>
    </div>
  </div>
  <!-- Popup thông báo ở giữa màn hình -->
<div id="deleteStaffModal" class="modal" style="display:none;">
  <div class="delete-staff-modal-dialog">
    <div class="delete-staff-modal-content">
      <div class="delete-staff-modal-title" id="deleteStaffModalMsg">Bạn có chắc chắn muốn xóa nhân viên này?</div>
      <div class="delete-staff-modal-actions">
        <button class="delete-staff-btn-confirm" id="deleteStaffModalBtnOK">Xóa</button>
        <button class="delete-staff-btn-cancel" id="deleteStaffModalBtnCancel">Hủy</button>
      </div>
    </div>
  </div>
</div>
  <!-- Popup sửa đơn hàng -->
<div id="orderEditModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="orderEditModalLabel" aria-hidden="true" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content order-edit-modal-box" id="orderEditModalContent">
      <!-- Nội dung popup sửa đơn hàng sẽ render vào đây -->
    </div>
    <div class="edit-modal-overlay" id="editModalOverlay" style="display:none;"></div>
  </div>
</div>
<!-- Popup Đã lưu thành công -->
<div class="modal fade" id="thankModal" tabindex="-1" role="dialog" aria-labelledby="thankModalLabel" aria-hidden="true" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <div class="popup-thank">
          <div class="title" id="thankModalTitle">Đã lưu thành công!</div>
          <button class="btn-back" id="thankModalBtnBack" onclick="closeThankModal()">Quay lại</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Popup thông báo sau khi in bill -->
<div id="customModal" style="display:none;">
  <div class="custom-modal-backdrop"></div>
  <div class="custom-modal-box">
    <div id="customModalMsg">Nội dung thông báo</div>
    <div style="text-align:center; margin-top:20px;">
      <button id="customModalBtnOK" class="btn-ok">OK</button>
      <button id="customModalBtnCancel" class="btn-cancel" style="display:none;">Cancel</button>
    </div>
  </div>
</div>
  <script>
    // --- ĐĂNG NHẬP, NAVBAR ---
    if(!localStorage.getItem('isLoggedIn')) window.location.replace('login.html');
    function showLogoutTabIfLoggedIn() {
      var logoutTab = document.getElementById('logoutTab');
      if(localStorage.getItem('isLoggedIn') === '1') {
        if (logoutTab) logoutTab.style.display = '';
      } else {
        if (logoutTab) logoutTab.style.display = 'none';
      }
    }
    function logout() {
      localStorage.removeItem('isAdmin');
      localStorage.removeItem('isLoggedIn');
      window.location.replace('login.html');
    }
    fetch('navbar.html').then(r=>r.text()).then(html=>{
      document.querySelector('#navbar-container .desktop-navbar').innerHTML = html;
      showLogoutTabIfLoggedIn();
      var logoutTab = document.getElementById('logoutTab');
      if(logoutTab) logoutTab.onclick = logout;
    });
    document.addEventListener('DOMContentLoaded', function(){
      showLogoutTabIfLoggedIn();
    });

    // --- BILL PANEL ---
    const inputOrderCode = document.getElementById('bill-order-code');
    const btnSearch = document.getElementById('bill-search-btn');
    const btnPrint = document.getElementById('bill-print-btn');
    const btnReset = document.getElementById('bill-reset-btn');
    const billStatusNote = document.getElementById('bill-status-note');
    const billArea = document.getElementById('bill-print-area');
    let currentBillData = null, currentOrderCode = null, isPaid = false;

    btnSearch.onclick = async function() {
      const code = inputOrderCode.value.trim();
      if (!code) {
        billStatusNote.innerHTML = '';
        billArea.innerHTML = '';
        btnPrint.disabled = true;
        return;
      }
      billArea.innerHTML = '<div style="text-align:center;color:#219a50;margin:14px 0;">Đang lấy dữ liệu...</div>';
      billStatusNote.innerHTML = '';
      btnPrint.disabled = true;
      currentBillData = null; currentOrderCode = null; isPaid = false;
      try {
        const resp = await fetch('/api/getbill?order=' + encodeURIComponent(code));
        if (!resp.ok) throw new Error('Lỗi server');
        const data = await resp.json();
        if (!data || !data.bill || !Array.isArray(data.bill) || data.bill.length === 0) {
          billArea.innerHTML = '<div style="color:red;text-align:center;margin:10px 0;">Không tìm thấy đơn hàng!</div>';
          billStatusNote.innerHTML = '';
          btnPrint.disabled = true;
          return;
        }
        currentBillData = data; currentOrderCode = code;
        isPaid = data.bill.some(row => (row.status && row.status.trim() === "Đã thanh toán"));
        const unpaid = data.bill.some(row => !row.status || row.status.trim() === "");
        if (isPaid) {
          billStatusNote.innerHTML = `<span class="bill-status-paid"><i class="fa fa-check-circle"></i> Đã thanh toán</span>`;
          btnPrint.disabled = false;
        } else if (unpaid) {
          billStatusNote.innerHTML = `<span class="bill-status-unpaid"><i class="fa fa-exclamation-triangle"></i> CHƯA thanh toán!</span>`;
          btnPrint.disabled = false;
        } else {
          billStatusNote.innerHTML = '';
          btnPrint.disabled = true;
        }
        renderBill(data);
      } catch (e) {
        billArea.innerHTML = '<div style="color:red;text-align:center;margin:10px 0;">Lỗi kết nối: ' + (e.message||e) + '</div>';
        billStatusNote.innerHTML = '';
        btnPrint.disabled = true;
      }
    };

    btnPrint.onclick = function() {
      if (!currentBillData || !currentOrderCode) return;
      let printed = false;
      const handleAfterPrint = async () => {
        if (printed) return;
        printed = true;
        window.removeEventListener('afterprint', handleAfterPrint);
        showCustomModal(
          'Bạn đã in hóa đơn thành công?<br><small>Nhấn OK để xác nhận, hoặc Cancel để KHÔNG ghi nhận thanh toán.</small>',
          async function() {
            btnPrint.disabled = false;
            try {
              await fetch('/api/frintbill', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  order: currentOrderCode,
                  items: currentBillData.bill.map(row => ({ maNV: row.maNV, caLV: row.caLV }))
                })
              });
              await loadOrderList();
              await btnSearch.onclick();
              showCustomModal('Đã ghi nhận thanh toán thành công!', null);
            } catch (e) {
              showCustomModal('Lỗi cập nhật trạng thái thanh toán:<br>' + (e.message||e));
            }
          },
          function() {}
        );
      };
      window.addEventListener('afterprint', handleAfterPrint);
      window.print();
    };

    btnReset.onclick = function() {
      inputOrderCode.value = '';
      billStatusNote.innerHTML = '';
      billArea.innerHTML = '';
      btnPrint.disabled = true;
      currentBillData = null; currentOrderCode = null; isPaid = false;
    };

    function renderBill(data) {
      if (!data || !data.bill || data.bill.length === 0) { billArea.innerHTML = ''; return; }
      const row = data.bill[0], orderDate = row.orderDate || "", orderCode = row.orderCode || "",
            customer = row.customer || {}, performDate = data.now || "";
      let tableRows = '', total = 0;
      data.bill.forEach(item => {
        if (+item.donGia > 0) {
          tableRows += `<tr>
            <td>${item.maNV||''}</td>
            <td class="td-num">${item.caLV||''}</td>
            <td class="td-price">${formatMoney(item.donGia)}</td>
            <td class="td-total">${formatMoney(item.thanhTien)}</td>
          </tr>`;
          total += +item.thanhTien;
        }
      });

      const tongCong = row.tongCong !== undefined && row.tongCong !== "" ? row.tongCong : total;
      const giamGia = row.giamGia !== undefined && row.giamGia !== "" ? row.giamGia : 0;
      const tongThu = row.tongThu !== undefined && row.tongThu !== "" ? row.tongThu : (total - Number(giamGia));

     billArea.innerHTML = `
  <div class="bill-print-wrapper">
    <div class="bill-logo-title">GooDjn DJ Coffee & Beer</div>
    <div class="bill-addr">65 Đ. Ngô Quyền, Phường 6, Quận 10, Hồ Chí Minh</div>
    <div class="bill-phone">SDT: 0902 926 636</div>
    <div class="bill-title-main">BILL DỊCH VỤ NHÂN VIÊN</div>
    <div class="bill-info-row"><span>Ngày đặt hàng</span><span>${orderDate}</span></div>
    <div class="bill-info-row"><span>Số đơn đặt hàng</span><span>${orderCode}</span></div>
    <div class="bill-info-row"><span>Ngày thực hiện</span><span>${performDate}</span></div>
    <div class="bill-section-title">Thông tin khách hàng</div>
    <div class="bill-info-row"><span>Tên khách hàng</span><span>${customer.name||""}</span></div>
    <div class="bill-info-row"><span>Số điện thoại</span><span>${customer.phone||""}</span></div>
    <div class="bill-info-row"><span>Email</span><span>${customer.email||""}</span></div>
    <div class="bill-info-row"><span>Thẻ bàn số</span><span>${customer.tableNum||""}</span></div>
    <table class="bill-table">
      <thead>
        <tr>
          <th>Mã NV</th>
          <th>Ca LV</th>
          <th>Đơn giá</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody>${tableRows}</tbody>
    </table>
    <hr>
    <div class="bill-info-row">
      <span>Tổng cộng</span>
      <span>${formatMoney(tongCong)} đ</span>
    </div>
    <div class="bill-info-row">
      <span>Giảm giá</span>
      <span>${formatMoney(giamGia)} đ</span>
    </div>
    <div class="bill-info-row" style="font-weight:bold;">
      <span>Tổng thu</span>
      <span>${formatMoney(tongThu)} đ</span>
    </div>
  <div class="bill-customer-thank">
  Cảm ơn Quý Khách đã chọn dịch <br>
  <span class="bill-thank-shop">vụ tại GooDjn DJ Coffee & Beer!</span>
  </div>
  </div>
`; 
    }
    function formatMoney(val) {
      try { return Number(val).toLocaleString('vi-VN'); } catch { return val; }
    }
    inputOrderCode.addEventListener('keyup', function(e) { if (e.key === 'Enter') btnSearch.click(); });

    // --- ORDER LIST + SEARCH + PAGINATION ---
    let ordersData = [], filteredOrders = [], orderTablePage = 1, orderEntriesPerPage = 10;
    const orderEntriesSelect = document.getElementById('order-entries-select');
    const orderPaginationDiv = document.getElementById('order-pagination');
    const orderSearchInput = document.getElementById('order-search-input');
    const orderSearchClear = document.getElementById('order-search-clear');

    let searchTimer = null;
    function filterOrders(keyword) {
      if (!keyword) return ordersData.slice();
      const kw = keyword.toLowerCase();
      return ordersData.filter(o =>
        String(o.orderCode).toLowerCase().includes(kw) ||
        (o.customerName && o.customerName.toLowerCase().includes(kw)) ||
        (o.tableNum && String(o.tableNum).toLowerCase().includes(kw)) ||
        (o.maNVs && o.maNVs.toLowerCase().includes(kw)) ||
        (o.status && o.status.toLowerCase().includes(kw)) ||
        (o.total && String(o.total).toLowerCase().includes(kw))
      );
    }
    function doSearchOrderList() {
      const keyword = orderSearchInput.value.trim();
      filteredOrders = filterOrders(keyword);
      orderTablePage = 1;
      renderOrderTable();
      renderOrderPagination();
    }

    orderSearchInput.addEventListener('keyup', function(e) {
      if (e.key === 'Enter') doSearchOrderList();
      else {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(doSearchOrderList, 340);
      }
    });
    orderSearchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(doSearchOrderList, 340);
    });
    orderSearchClear.addEventListener('click', function() {
      orderSearchInput.value = '';
      filteredOrders = ordersData.slice();
      orderTablePage = 1;
      renderOrderTable();
      renderOrderPagination();
      orderSearchInput.focus();
    });
    orderEntriesSelect.addEventListener('change', function() {
      orderEntriesPerPage = Number(this.value);
      orderTablePage = 1;
      renderOrderTable();
      renderOrderPagination();
    });

    function renderOrderTable() {
      const table = document.querySelector('#order-list-table tbody');
      const data = filteredOrders.length ? filteredOrders : [];
      if (!data.length) {
        table.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#888;">Không có đơn hàng.</td></tr>`;
        return;
      }
      const startIdx = (orderTablePage - 1) * orderEntriesPerPage;
      const endIdx = Math.min(startIdx + orderEntriesPerPage, data.length);
      let html = '';
      for (let i = startIdx; i < endIdx; ++i) {
        const o = data[i];
        html += `<tr>
          <td>${i + 1}</td>
          <td class="thoi-gian">${o.timestamp || ''}</td>
          <td>${o.orderCode}</td>
          <td class="ten-khach-hang" style="text-align:left;">${o.customerName}</td>
          <td>${o.tableNum}</td>
          <td class="ma-nv" style="text-align:left;">${o.maNVs}</td>
          <td style="text-align:right;">${Number(o.total).toLocaleString('vi-VN')}</td>
          <td>${
            o.status === 'Đã thanh toán'
            ? `<button class="order-status-paid" data-order="${o.orderCode}">Đã thanh toán</button>`
            : `<button class="order-status-btn" data-order="${o.orderCode}">Chưa thanh toán</button>`
          }</td>
          <td>
            <button class="order-edit-btn" data-order="${o.orderCode}">Sửa</button>
          </td>
        </tr>`;
      }
      table.innerHTML = html;
      Array.from(table.querySelectorAll('.order-status-btn, .order-status-paid')).forEach(btn => {
        btn.addEventListener('click', function() {
          const order = this.getAttribute('data-order');
          if (order) {
            inputOrderCode.value = order;
            btnSearch.click();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      });
      Array.from(table.querySelectorAll('.order-edit-btn')).forEach(btn => {
        btn.addEventListener('click', function() {
          const order = this.getAttribute('data-order');
          if (order) {
            showEditOrderModal(order);
          }
        });
      });
    }
    function renderOrderPagination() {
      const data = filteredOrders.length ? filteredOrders : [];
      if (!data.length) { orderPaginationDiv.innerHTML = ''; return; }
      const totalPages = Math.ceil(data.length / orderEntriesPerPage);
      let html = '';
      if (totalPages > 1) {
        html += `<button ${orderTablePage === 1 ? 'disabled' : ''} onclick="gotoOrderPage(${orderTablePage - 1})">Previous</button>`;
        let start = Math.max(1, orderTablePage - 2);
        let end = Math.min(totalPages, orderTablePage + 2);
        if (orderTablePage <= 3) end = Math.min(5, totalPages);
        if (orderTablePage >= totalPages - 2) start = Math.max(1, totalPages - 4);
        if (start > 1) html += `<button onclick="gotoOrderPage(1)">1</button>${start > 2 ? '<span>...</span>' : ''}`;
        for (let i = start; i <= end; ++i) {
          html += `<button class="${i === orderTablePage ? 'active' : ''}" onclick="gotoOrderPage(${i})">${i}</button>`;
        }
        if (end < totalPages) html += `${end < totalPages - 1 ? '<span>...</span>' : ''}<button onclick="gotoOrderPage(${totalPages})">${totalPages}</button>`;
        html += `<button ${orderTablePage === totalPages ? 'disabled' : ''} onclick="gotoOrderPage(${orderTablePage + 1})">Next</button>`;
      }
      orderPaginationDiv.innerHTML = html;
    }
    window.gotoOrderPage = function(page) {
      orderTablePage = page;
      renderOrderTable();
      renderOrderPagination();
    };
    async function loadOrderList() {
      const table = document.querySelector('#order-list-table tbody');
      table.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#888;">Đang tải...</td></tr>`;
      try {
        const resp = await fetch('/api/listorders');
        if (!resp.ok) throw new Error('Không thể tải dữ liệu!');
        const { orders } = await resp.json();
        ordersData = Array.isArray(orders) ? orders : [];
        filteredOrders = ordersData.slice();
        orderTablePage = 1;
        renderOrderTable();
        renderOrderPagination();
      } catch (e) {
        ordersData = []; filteredOrders = [];
        table.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#e53935;">Lỗi tải dữ liệu!</td></tr>`;
        orderPaginationDiv.innerHTML = '';
      }
    }
    loadOrderList();

    // ==== POPUP SỬA ĐƠN HÀNG ====
async function showEditOrderModal(orderCode) {
  let order, products, availableProducts;
  try {
    const resp = await fetch('/api/listorders?order=' + encodeURIComponent(orderCode));
    if (!resp.ok) throw new Error('Không lấy được dữ liệu!');
    const data = await resp.json();
    order = data.order;
    products = data.products || [];
    availableProducts = data.availableProducts || [];
    if (!order) throw new Error('Không tìm thấy đơn hàng!');
  } catch (e) {
    showCustomModal('Lỗi: ' + (e.message || e));
    return;
  }
  const productMap = {};
  products.forEach(item => {
    if (!productMap[item.maNV]) productMap[item.maNV] = {};
    productMap[item.maNV][item.caLV] = item.donGia;
  });

  const modal = document.getElementById('orderEditModal');
  const content = document.getElementById('orderEditModalContent');
  function renderMaNVOptions(selectedMaNV, onlyAvailable = false, usedNVs = []) {
  let list = onlyAvailable ? availableProducts : products;
  if (onlyAvailable) {
    list = list.filter(p =>
      p.maNV.trim() !== '' && // Đảm bảo maNV không rỗng
      !(p.lockStatus && (p.lockStatus.trim().toLowerCase() === "nghỉ việc" || p.lockStatus.trim().toLowerCase() === "nghỉ phép")) && // Chỉ loại bỏ "Nghỉ việc" hoặc "Nghỉ phép"
      !(p.isBusy && p.isBusy.trim().toLowerCase() === "đang bận") && // Chỉ loại bỏ "Đang bận"
      !usedNVs.includes(p.maNV)
    );
  }
  let uniqueMaNVs = Array.from(new Set(list.map(p => p.maNV)));
  let html = `<option value="">--Chọn NV--</option>`;
  html += uniqueMaNVs.map(ma =>
    `<option value="${ma}" ${ma === selectedMaNV ? 'selected' : ''}>${ma}</option>`
  ).join('');
  return html;
}
  function renderCaLVOptions(maNV, selectedCaLV) {
    if (!maNV) return `<option value="">--Chọn ca--</option>`;
    let caLVs = products.filter(p => p.maNV === maNV).map(p => p.caLV);
    caLVs = Array.from(new Set(caLVs));
    let html = `<option value="">--Chọn ca--</option>`;
    html += caLVs.map(ca =>
      `<option value="${ca}" ${ca == selectedCaLV ? 'selected' : ''}>${ca}</option>`
    ).join('');
    return html;
  }

  function updateDonGia(tr) {
    const maNV = tr.querySelector('.nv-maNV').value;
    const caLV = tr.querySelector('.nv-caLV').value;
    const donGiaInput = tr.querySelector('.nv-donGia');
    const donGiaRaw = (productMap[maNV] && productMap[maNV][caLV]) ? productMap[maNV][caLV] : '';
    donGiaInput.value = formatInputMoney(donGiaRaw);
    const thanhTienInput = tr.querySelector('.nv-thanhTien');
    thanhTienInput.value = donGiaRaw ? formatInputMoney(donGiaRaw) : '';
    calSummary();
  }

      let nvRowsHtml = '';
      let usedNVs = [];
      (order.nhanVien || []).forEach((nv, idx) => {
        usedNVs.push(nv.maNV);
    nvRowsHtml += `<tr data-idx="${idx}">
  <td>
    <select class="nv-maNV">${renderMaNVOptions(nv.maNV, false)}</select>
  </td>
  <td>
    <select class="nv-caLV">${renderCaLVOptions(nv.maNV, nv.caLV)}</select>
  </td>
  <td>
    <input class="nv-donGia" value="${formatInputMoney(nv.donGia || '')}" />
  </td>
  <td>
    <input class="nv-thanhTien" value="${formatInputMoney(nv.thanhTien || '')}" autocomplete="off" />
  </td>
  <td>
    <button class="btn-xoa-nv" type="button">Xóa</button>
  </td>
</tr>`;
      });

      content.innerHTML = `
        <button class="modal-close-btn" id="edit-modal-close" title="Đóng">&times;</button>
        <div class="modal-title">THÔNG TIN ĐƠN HÀNG</div>
        <div class="order-code">Mã đơn hàng: ${order.orderCode}</div>
        <div class="order-status">Trạng thái: ${order.trangThai === 'Đã thanh toán' ? '<span style="color:#15a138">Đã thanh toán</span>' : '<span style="color:#e53935">Chưa thanh toán</span>'}</div>
        <hr class="divider"/>
        <div class="form-row">
          <div class="form-label">Tên khách hàng</div>
          <input id="edit-customer-name" class="form-input" value="${order.customer.name || ''}" maxlength="64" />
        </div>
        <div class="form-row">
          <div class="form-label">Số điện thoại</div>
          <input id="edit-customer-phone" class="form-input" value="${order.customer.phone || ''}" maxlength="24" />
        </div>
        <div class="form-row">
          <div class="form-label">Địa chỉ Email</div>
          <input id="edit-customer-email" class="form-input" value="${order.customer.email || ''}" maxlength="64" />
        </div>
        <div class="form-row">
          <div class="form-label">Thẻ bàn số</div>
          <input id="edit-table-num" class="form-input" type="number" min="0" max="99" value="${order.tableNum || ''}" />
        </div>
        <div class="form-row">
          <div class="form-label">Ghi chú</div>
          <textarea id="edit-note" class="form-input">${order.ghiChu || ''}</textarea>
        </div>
        <div class="form-row">
          <div class="form-label">Ghi chú quản lý</div>
          <textarea id="edit-note-ql" class="form-input">${order.noteQuanLy || ''}</textarea>
        </div>
        <div class="nv-table-row">
          <span class="nv-table-title">1.Danh sách Nhân viên</span>
          <button class="btn-them-nv" type="button" id="btn-them-nv">Thêm NV mới</button>
        </div>
        <table class="staff-list-table" id="edit-nv-table">
          <thead>
            <tr>
              <th>Mã NV</th>
              <th>Ca LV</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
              <th>Sửa/Xóa</th>
            </tr>
          </thead>
          <tbody>
            ${nvRowsHtml}
          </tbody>
        </table>
        <table class="total-table">
          <tr class="total-row">
            <td style="width:140px;">Tổng cộng</td>
            <td><input id="edit-tongCong" value="${order.tongCong || ''}" readonly style="width:90px;text-align:right; font-weight:700; color:#13ad2f; background:#fff; border:none;" /></td>
          </tr>
          <tr class="giamgia-row">
            <td>Giảm giá</td>
            <td><input id="edit-giamGia" autocomplete="off" value="${formatInputMoney(order.giamGia || '')}" style="width:90px;text-align:right;" /></td>
          </tr>
          <tr class="tongthu-row">
            <td>Tổng thu</td>
            <td><input id="edit-tongThu" value="${order.tongThu || ''}" readonly style="width:90px;text-align:right;font-weight:700;color:#c00; background:#fff; border:none;" /></td>
          </tr>
        </table>
        <div class="edit-modal-actions">
          <button class="btn-save" id="edit-btn-save"><i class="fa fa-save"></i> Lưu</button>
          <button class="btn-cancel" id="edit-btn-cancel"><i class="fa fa-times"></i> Đóng</button>
        </div>
      `;
      modal.style.display = 'flex';

  content.querySelectorAll('#edit-nv-table tbody tr').forEach(tr => {
  const donGiaInput = tr.querySelector('.nv-donGia');
  const thanhTienInput = tr.querySelector('.nv-thanhTien');
  donGiaInput.addEventListener('input', function() {
    let donGiaRaw = this.value.replace(/[^\d]/g, '');
    this.value = formatInputMoney(donGiaRaw);
    thanhTienInput.value = formatInputMoney(donGiaRaw); // cập nhật thành tiền
    calSummary();
  });
  thanhTienInput.addEventListener('input', function() {
    let v = this.value.replace(/[^\d]/g,'');
    this.value = formatInputMoney(v);
    calSummary();
  });
});

// Giảm giá - luôn format khi nhập
document.getElementById('edit-giamGia').addEventListener('input', function() {
  let v = this.value.replace(/[^\d]/g,'');
  this.value = formatInputMoney(v);
  calSummary();
});
      document.getElementById('edit-btn-cancel').onclick = () => { modal.style.display = 'none'; };
      document.getElementById('edit-modal-close').onclick = () => { modal.style.display = 'none'; };

      content.querySelectorAll('#edit-nv-table tbody tr').forEach(tr => {
        tr.querySelector('.nv-maNV').onchange = function() {
          let maNV = this.value;
          let caLVSelect = tr.querySelector('.nv-caLV');
          caLVSelect.innerHTML = renderCaLVOptions(maNV, caLVSelect.value);
          updateDonGia(tr);
        };
        tr.querySelector('.nv-caLV').onchange = function() {
          updateDonGia(tr);
        };
    tr.querySelector('.btn-xoa-nv').onclick = function() {
    showDeleteStaffModal(
    function() { tr.remove(); calSummary(); },
    function() { /* Không làm gì nếu hủy */ }
  );
};
      });
  document.getElementById('btn-them-nv').onclick = function() {
  const tbody = document.getElementById('edit-nv-table').querySelector('tbody');
  let idx = tbody.children.length;
  let currUsedNVs = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const v = tr.querySelector('.nv-maNV')?.value;
    if (v) currUsedNVs.push(v);
  });
  let trElem = document.createElement('tr');
  trElem.setAttribute('data-idx', idx);
  trElem.innerHTML = `
    <td><select class="nv-maNV">${renderMaNVOptions('', true, currUsedNVs)}</select></td>
    <td><select class="nv-caLV"><option value="">--Chọn ca--</option></select></td>
    <td><input class="nv-donGia" value="" /></td>
    <td><input class="nv-thanhTien" autocomplete="off" value="" /></td>
    <td><button class="btn-xoa-nv" type="button">Xóa</button></td>
  `;
  tbody.appendChild(trElem);
  // SỰ KIỆN: Khi sửa đơn giá, tự động cập nhật thành tiền cùng dòng
trElem.querySelector('.nv-donGia').addEventListener('input', function() {
  let donGiaRaw = this.value.replace(/[^\d]/g, '');
  this.value = formatInputMoney(donGiaRaw);
  trElem.querySelector('.nv-thanhTien').value = formatInputMoney(donGiaRaw);
  calSummary();
});

  // SỰ KIỆN FORMAT cho input Thành tiền 
  trElem.querySelector('.nv-thanhTien').addEventListener('input', function() {
    let v = this.value.replace(/[^\d]/g,'');
    this.value = formatInputMoney(v);
    calSummary();
  });

  // Sự kiện chọn NV thì cập nhật dropdown Ca LV và Đơn giá, Thành tiền
  const maNVSelect = trElem.querySelector('.nv-maNV');
  const caLVSelect = trElem.querySelector('.nv-caLV');
  maNVSelect.onchange = function() {
    let maNV = this.value;
    caLVSelect.innerHTML = renderCaLVOptions(maNV, '');
    updateDonGia(trElem);
  };
  caLVSelect.onchange = function() {
    updateDonGia(trElem);
  };
  // Sự kiện xóa dòng
  trElem.querySelector('.btn-xoa-nv').onclick = function() {
    showDeleteStaffModal(
      function() { trElem.remove(); calSummary(); },
      function() { }
    );
  };
  // Sự kiện nhập thành tiền thủ công
  trElem.querySelector('.nv-thanhTien').addEventListener('input', calSummary);
};
function formatInputMoney(val) {
  val = val + '';
  val = val.replace(/[^\d]/g, '');
  if (!val) return '';
  return Number(val).toLocaleString('vi-VN');
}
  function showDeleteStaffModal(onOK, onCancel) {
  var modal = document.getElementById('deleteStaffModal');
  modal.style.display = 'flex';
  document.getElementById('deleteStaffModalBtnOK').onclick = function() {
    modal.style.display = 'none';
    if (onOK) onOK();
  };
  document.getElementById('deleteStaffModalBtnCancel').onclick = function() {
    modal.style.display = 'none';
    if (onCancel) onCancel();
  };
}

  function calSummary() {
  const tbody = document.getElementById('edit-nv-table').querySelector('tbody');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    let v = Number((tr.querySelector('.nv-thanhTien')||{value:0}).value.replace(/[^\d]/g,''));
    if(!isNaN(v)) sum += v;
  });
  document.getElementById('edit-tongCong').value = formatInputMoney(sum);
  let giam = Number((document.getElementById('edit-giamGia').value||'').replace(/[^\d]/g,''));
  if(isNaN(giam)) giam = 0;
  let tongThu = sum - giam;
  if(tongThu < 0) tongThu = 0;
  document.getElementById('edit-tongThu').value = formatInputMoney(tongThu);
}
      content.querySelectorAll('.nv-thanhTien, .nv-donGia, .nv-caLV').forEach(inp => inp.oninput = calSummary);
      document.getElementById('edit-giamGia').oninput = calSummary;
      calSummary();

  document.getElementById('edit-btn-save').onclick = async function() {
  let customer = {
    name: document.getElementById('edit-customer-name').value.trim(),
    phone: document.getElementById('edit-customer-phone').value.trim(),
    email: document.getElementById('edit-customer-email').value.trim()
  };
  let tableNum = document.getElementById('edit-table-num').value.trim();
  let ghiChu = document.getElementById('edit-note').value.trim();
  let tongCong = document.getElementById('edit-tongCong').value.replace(/\D/g,'');
  let giamGia = document.getElementById('edit-giamGia').value.replace(/\D/g,'');
  let tongThu = document.getElementById('edit-tongThu').value.replace(/\D/g,'');
  let nhanVien = [];
  content.querySelectorAll('#edit-nv-table tbody tr').forEach(tr=>{
    let maNV = (tr.querySelector('.nv-maNV')||{value:''}).value.trim();
    let caLV = (tr.querySelector('.nv-caLV')||{value:''}).value.trim();
    let donGia = (tr.querySelector('.nv-donGia')||{value:''}).value.replace(/\D/g,'');
    let thanhTien = (tr.querySelector('.nv-thanhTien')||{value:''}).value.replace(/\D/g,'');
    if(maNV && caLV && donGia && thanhTien) nhanVien.push({maNV,caLV,donGia,thanhTien});
  });
  if (nhanVien.length == 0) {
    showCustomModal('Phải có ít nhất 1 nhân viên phục vụ!');
    return;
  }
  const overlay = document.getElementById('editModalOverlay');
  try {
    document.getElementById('edit-btn-save').disabled = true;
    if (overlay) overlay.style.display = 'block'; // Hiện overlay

    let postBody = {
      orderCode: order.orderCode,
      customer,
      tableNum,
      ghiChu,
      nhanVien,
      tongCong,
      giamGia,
      tongThu,
      trangThai: order.trangThai,
      noteQuanLy: document.getElementById('edit-note-ql').value.trim(), // Sửa dòng này!
      inBill: order.inBill||''
    };
    let resp = await fetch('/api/listorders', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(postBody)
    });
    let data = await resp.json();

    if (data && data.success) {
  document.getElementById('orderEditModal').style.display = 'none';
  if (overlay) overlay.style.display = 'none'; // Ẩn overlay khi đóng popup
  showThankModal('Đã lưu thành công!');

  // --- Render lại danh sách đơn hàng ---
  ordersData = Array.isArray(data.orders) ? data.orders : [];
  filteredOrders = ordersData.slice();
  orderTablePage = 1;
  renderOrderTable();
  renderOrderPagination();

  // --- Render lại bill ---
  document.getElementById('bill-order-code').value = orderCode;
  const newBillData = { bill: data.bill };
  currentBillData = newBillData;
  currentOrderCode = orderCode;
  isPaid = data.bill.some(row => (row.status && row.status.trim() === "Đã thanh toán"));
  const unpaid = data.bill.some(row => !row.status || row.status.trim() === "");
  if (isPaid) {
    billStatusNote.innerHTML = `<span class="bill-status-paid"><i class="fa fa-check-circle"></i> Đã thanh toán</span>`;
    btnPrint.disabled = false;
  } else if (unpaid) {
    billStatusNote.innerHTML = `<span class="bill-status-unpaid"><i class="fa fa-exclamation-triangle"></i> CHƯA thanh toán!</span>`;
    btnPrint.disabled = false;
  } else {
    billStatusNote.innerHTML = '';
    btnPrint.disabled = true;
  }
  renderBill(newBillData);
} 
    else {
      if (overlay) overlay.style.display = 'none';
      showThankModal('Lưu thất bại! ' + (data && data.error ? data.error : ''));
      document.getElementById('edit-btn-save').disabled = false;
    }
  } catch(e) {
    if (overlay) overlay.style.display = 'none';
    showThankModal('Lỗi lưu: ' + (e.message||e));
    document.getElementById('edit-btn-save').disabled = false;
  }
};
    }
  function showThankModal(title = "Đã lưu thành công!") {
  var modal = document.getElementById('thankModal');
  var titleElem = document.getElementById('thankModalTitle');
  titleElem.innerHTML = title;
  modal.classList.add('show');
  modal.style.display = 'block';
}
function closeThankModal() {
  var modal = document.getElementById('thankModal');
  modal.classList.remove('show');
  modal.style.display = 'none';
  loadOrderList() //reload lại trang tại đây 
}
  </script>
  <script>
/**
 * Hiện popup xác nhận, thay cho confirm
 * @param {string} msg - Nội dung thông báo
 * @param {function} onOK - Hàm khi bấm OK
 * @param {function} [onCancel] - Hàm khi bấm Cancel (không truyền thì chỉ hiện nút OK)
 */
function showCustomModal(msg, onOK, onCancel) {
  var modal = document.getElementById('customModal');
  var msgBox = document.getElementById('customModalMsg');
  var btnOK = document.getElementById('customModalBtnOK');
  var btnCancel = document.getElementById('customModalBtnCancel');
  msgBox.innerHTML = msg || '';
  modal.style.display = 'flex';
  btnCancel.style.display = onCancel ? '' : 'none';
  // Remove old events
  btnOK.onclick = btnCancel.onclick = null;
  btnOK.onclick = function() {
    modal.style.display = 'none';
    if (onOK) onOK();
  };
  btnCancel.onclick = function() {
    modal.style.display = 'none';
    if (onCancel) onCancel();
  };
  // Đóng popup khi nhấn phím ESC
  document.onkeydown = function(e) {
    if (e.key === 'Escape') {
      modal.style.display = 'none';
      document.onkeydown = null;
      if (onCancel) onCancel();
    }
  };
}
// ----- LOGIC SHOW/HIDE POPUP giống quanly.html -----
function showOrderEditModal() {
  var modal = document.getElementById('orderEditModal');
  modal.classList.add('show');
  modal.style.display = 'block';
}
function hideOrderEditModal() {
  var modal = document.getElementById('orderEditModal');
  modal.classList.remove('show');
  modal.style.display = 'none';
}
</script>
  <script>
function redirectToLogin() {
    // Xoá toàn bộ cookie phía client
    document.cookie.split(";").forEach(function(c) {
      document.cookie = c.replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    // Chuyển hướng tới trang đăng nhập
    window.location.href = "/login";
}

function checkAndLogoutAtMidnight() {
    const now = new Date();
    const tzOffset = 7 * 60; // phút cho Asia/Ho_Chi_Minh
    const local = new Date(now.getTime() + (tzOffset - now.getTimezoneOffset()) * 60000);
    const hours = local.getHours();
    const minutes = local.getMinutes();
    const seconds = local.getSeconds();

    if (hours === 0 && minutes === 0 && seconds <= 10) {
        redirectToLogin();
    }
}
setInterval(checkAndLogoutAtMidnight, 12000);
</script>
<script>
document.getElementById('wake-btn').onclick = function() {
  window.location.reload();
};
</script>
</body>
</html>
