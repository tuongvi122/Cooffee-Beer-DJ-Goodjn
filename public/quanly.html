<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng – Coffee & Beer DJ GooDjn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #fafbfc;
      color: #23272f;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #fafbfc;
    }
    #navbar-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      z-index: 10000;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
    }
    .site-content {
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      padding-top: 60px;
      padding-bottom: 50px;  /* hoặc 60px nếu cần rộng hơn, tùy chiều cao footer */
    }
    #footer-container {
      background: #228B22;
      color: #fff;
      width: 100vw;
      min-height: 54px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      box-sizing: border-box;
      text-align: center;
      padding: 0 10px;
      position: fixed;
      left: 0;
      bottom: 0;
      z-index: 999;
    }
    #footer-container div {
      width: 100%;
      text-align: center;
      line-height: 1.15;
      word-break: break-word;
    }
    .container {
      max-width: 1200px;
      margin: 22px auto 18px;
      padding: 18px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      position: relative; /* Để nút "Đánh thức" căn theo container */
    }
  .wake-btn-absolute {
  position: absolute;
  top: 18px;           /* Chỉnh cao/thấp tùy vị trí */
  right: 6px;         /* Chỉnh sát/xa biên phải */
  background: #ffb300;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 7px;
  padding: 4px 12px;
  font-size: 0.98em;
  cursor: pointer;
  z-index: 10;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
}
.wake-btn-absolute i {
  margin-right: 6px;
  font-size: 1.1em;
}
    h2 {
      text-align: center;
      margin: 12px 0 18px;
      font-size: 1.17em;
      color: #157c07;
      letter-spacing: 1px;
      font-family: Roboto,Arial,sans-serif;
      font-weight: bold;
      text-transform: uppercase;
    }
    .table-actions {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .table-actions label {
      font-weight: 500;
      margin-right: 6px;
    }
    .table-actions .entries-select {
      padding: 3px 7px;
      border-radius: 5px;
      border: 1px solid #888;
      font-size: 15px;
    }
    .table-actions .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .table-actions input[type="text"] {
      padding: 5px 10px;
      border: 1.2px solid #888;
      border-radius: 5px;
      font-size: 15px;
      width: 200px;
      transition: border 0.2s;
    }
    #thankModal .modal-dialog {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0 auto;
    }

    /* MOBILE TABLE CUSTOM - ONLY FOR MOBILE */
    @media (max-width: 600px) {
      h2 {
        font-size: 1.2em !important;
        margin: 10px 0 18px 0 !important;
        letter-spacing: 0.5px;
        font-weight: 700;
        text-transform: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .container {
        padding: 7px 1vw 10px 1vw !important;
        border-radius: 0;
        max-width: 100vw;
        margin: 12px auto 0;
        box-shadow: none;
      }
      .table-actions {
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
        margin-top: 0;
        padding-right: 0;
        padding-left: 0;
      }
      .table-actions label[for="filterInput"] {
        display: none !important;
      }
      .table-actions .entries-select {
        font-size: 14px;
        padding: 2px 6px;
        margin: 0 2px 0 0;
        height: 28px;
      }
      .table-actions .search-box {
        margin-left: 0;
        flex: 1 1 0;
        width: 100%;
      }
      .table-actions input[type="text"] {
        font-size: 14px;
        width: 100%;
        padding: 5px 8px;
        margin: 0;
        border-radius: 5px;
      }
      #entriesSelect, .entries-select {
        min-width: 55px;
        max-width: 70px;
      }
      .table-actions > div {
        margin: 0;
        padding: 0;
      }
      .orders-table-wrap {
        overflow-x: unset;
        margin-bottom: 12px;
      }
      table.orders-table {
        display: none !important;
      }
      /* Mobile table style */
      .mobile-orders-table {
        display: table;
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 8px;
      }
      .mobile-orders-table-head {
        display: table-row;
        background: #eafce4;
        color: #20581f;
        font-weight: 600;
        font-size: 0.99em;
        border-radius: 8px 8px 0 0;
        border-bottom: 1.5px solid #cfd8dc;
      }
      .mobile-orders-table-head .col {
        display: table-cell;
        padding: 7px 2px 7px 5px;
        text-align: center;
        font-size: 0.95em;
        font-weight: 600;
        color: #20581f;
        border: 1px solid #cfd8dc;
        background: #eafce4;
        vertical-align: middle;
      }
      .mobile-orders-table-head .col.col-khach { text-align: center; }
      .mobile-orders-table-head .col.col-ban { text-align: center; }
      .mobile-orders-table-head .col.col-mnv { text-align: center;}
      .mobile-orders-table-head .col.col-tong { text-align: center;}
      .mobile-orders-table-head .col.col-xacnhan { text-align: center;}
      .mobile-orders-table-head .col.col-ghichu { display: none !important; }
      .mobile-orders-table-row {
        display: table-row;
        border-radius: 0;
        background: #fff;
        box-shadow: none;
        margin-bottom: 0;
        overflow: hidden;
      }
      .mobile-orders-table-row .col {
        display: table-cell;
        padding: 7px 2px 7px 5px;
        font-size: 0.97em;
        border: 1px solid #cfd8dc;
        vertical-align: middle;
        overflow: hidden;
        word-break: break-word;
        text-align: center;
        background: #fff;
      }
      .mobile-orders-table-row .col.col-khach {
        min-width: 90px;
        font-weight: 600;
        color: #20581f;
        text-align: left;
        padding-left: 7px;
        font-size: 0.98em;
      }
      .mobile-orders-table-row .col.col-ban {
        min-width: 34px;
        color: #1a237e;
        font-weight: 500;
        text-align: center;
        padding-left: 0;
        padding-right: 0;
        font-size: 0.98em;
      }
      .mobile-orders-table-row .col.col-mnv {
        min-width: 54px;
        color: #20581f;
        font-size: 0.97em;
        word-break: break-all;
        font-weight: 500;
        text-align: left;
        padding-left: 3px;
      }
      .mobile-orders-table-row .col.col-tong {
        min-width: 54px;
        color: #e53935;
        font-weight: 600;
        font-size: 0.99em;
        text-align: center;
        padding-right: 0;
        padding-left: 0;
      }
      .mobile-orders-table-row .col.col-xacnhan {
        min-width: 80px;
        text-align: center;
        display: table-cell;
        vertical-align: middle;
        padding: 0 2px;
      }
      .mobile-orders-table-row .col.col-ghichu {
        display: none !important;
      }
      .mobile-orders-table-row .btn-confirm,
      .mobile-orders-table-row .btn-daxacnhan,
      .mobile-orders-table-row .btn-huy {
        width: 72px;
        min-width: 62px;
        margin: 1px 0;
        font-size: 0.96em;
        padding: 4px 0;
      }
      .table-pagination {
        justify-content: center !important;
        margin-top: 10px !important;
        margin-bottom: 0 !important;
        gap: 0;
      }
      .table-pagination button {
        min-width: 30px;
        min-height: 28px;
        font-size: 0.96em;
        padding: 2px 8px;
        margin: 0 2px;
      }
      .table-pagination span {
        padding: 0 2px;
        font-size: 0.93em;
      }
      #showingInfo {
        font-size: 13px !important;
        color: #444;
        margin-top: 3px !important;
        margin-bottom: 0 !important;
        text-align: left;
        padding-left: 2px;
      }
      .mobile-orders-table-row .col.col-ghichu { display: none !important; }
    }
    /* END MOBILE TABLE */
    .orders-table-wrap {
      overflow-x: auto;
      margin-bottom: 12px;
    }
    table.orders-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1100px;
      margin-bottom: 8px;
    }
    table.orders-table th, table.orders-table td {
      padding: 8px 6px;
      border: 1px solid #cfd8dc;
      text-align: center;
      font-size: 1em;
      vertical-align: middle;
    }
    table.orders-table th {
      background: #eafce4;
      color: #20581f;
      font-weight: 600;
    }
    table.orders-table td {
      background: #fff;
    }
    .btn-confirm, .btn-huy, .btn-daxacnhan {
      padding: 4px 15px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.18s;
    }
    .btn-confirm { background: #16c924; }
    .btn-confirm:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-daxacnhan { background: #0b4fd7;}
    .btn-huy { background: #e53935; cursor: not-allowed; }
    .note-huy { color: #e53935; font-weight: 600; }
    .note-da { color: #0b4fd7; font-weight: 600; }
    .note-xacnhan { color: #16c924; font-weight: 600; }
    .table-pagination {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 2px;
      margin: 8px 0 0 0;
    }
    .table-pagination button {
      border: none;
      background: #fff;
      color: #1174e6;
      padding: 3px 10px;
      margin: 0 2px;
      border-radius: 5px;
      font-weight: 500;
      cursor: pointer;
      font-size: 15px;
      border: 1px solid #cfd8dc;
    }
    .table-pagination button.active,
    .table-pagination button:disabled {
      background: #0b8ffe;
      color: #fff;
      font-weight: bold;
      cursor: default;
    }
    .table-pagination button:disabled {
      opacity: 0.6;
    }
    .table-pagination span {
      padding: 0 4px;
      color: #444;
    }
    .ql-ghichu-box {
      min-width: 100px;
      text-align: left;
      font-size: 0.90em;
      color: #0b4fd7;
      word-break: break-word;
    }
      .modal {
      display: none;
      position: fixed;
      z-index: 12000 !important;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      background: rgba(0,0,0,0.2);
    }
    .modal.show { display: block; }
    .modal-dialog {
      position: relative;
      margin: 5% auto;
      max-width: 600px;
      width: 100%;
      min-width: 340px;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 0 0 34px 0;
      box-shadow: 0 0 20px rgb(2, 163, 18);
      border: 2px solid #14b55f;
      max-width: 100%;
    }
    .modal-header {
      padding: 15px 20px 0 20px;
      border-bottom: 1px solid #eee;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      margin: 0;
      font-size: 21px;
      flex: 1;
      text-align: center;
      color: #05458b;
      font-weight: bold;
    }
    .close {
      background: none;
      border: none;
      font-size: 28px;
      font-weight: bold;
      color: #e53935;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
    }
    .close:hover { color: #c62828; }
    .modal-body { 
      padding: 15px 16px;
    }
    .order-info-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .order-info-row label {
      min-width: 120px;
      font-weight: 500;
      color: #0b4fd7;
    }
    .order-info-row input {
      flex: 1;
      padding: 6px;
      border: 1px solid #bbb;
      border-radius: 4px;
      font-size: 1em;
      background: #f8f8ff;
    }
    .staff-list-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 0 0;
      table-layout: fixed;
      background: #fff;
    }
    .staff-list-table th, .staff-list-table td {
      border: 1px solid #d7d7d7;
      text-align: center;
      font-size: 0.96em;
      padding: 3px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #fff;
      max-width: 85px;
    }
    .staff-list-table th, .staff-list-table td { width: auto; }
    .staff-list-table th:nth-child(1), .staff-list-table td:nth-child(1) { width: 60px; }
    .staff-list-table th:nth-child(2), .staff-list-table td:nth-child(2) { width: 32px; }
    .staff-list-table th:nth-child(3), .staff-list-table td:nth-child(3) { width: 55px; }
    .staff-list-table th:nth-child(4), .staff-list-table td:nth-child(4) { width: 80px; }
    .staff-list-table th:nth-child(5), .staff-list-table td:nth-child(5) { width: 55px; }
    .btn-tatca, .btn-huydon, .btn-them-nv {
      padding: 4px 13px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-tatca { background: #0b4fd7; color: #fff; }
    .btn-huydon { background: #ff9800; color: #fff; }
    .btn-them-nv { background: #10b314; color: #fff; }
    .btn-them-nv:hover { background: #0e9e12; }
    .staff-both-btns {
      margin: 7px 0 10px 0;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .section-title { 
      font-weight: 600; 
      color: #1052e3; 
      margin-bottom: 6px; 
      margin-top: 8px;
      display: block; 
    }
    .ql-ghichu-input {
      width: 97.5%;
      min-height: 50px;
      border: 1px solid #aaa;
      border-radius: 4px;
      font-size: 1.1em;
      padding: 4px;
      margin-bottom: 12px;
      background: #f9f9fc;
      line-height: 1.4;
    }
    .modal-footer {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 14px;
    }
    .btn-popup-xacnhan, .btn-popup-close {
      padding: 8px 20px;
      border-radius: 5px;
      font-weight: 600;
      border: none;
      font-size: 15px;
      cursor: pointer;
      min-width: 100px;
      transition: background 0.2s;
    }
    .btn-popup-xacnhan { background: #10b314; color: #fff; }
    .btn-popup-close { background: #e53935; color: #fff; }
    .popup-thank {
      padding: 22px;
      text-align: center;
      border: 1px solid #222;
      background: #e1f1fb;
      border-radius: 9px;
    }
    .popup-thank .title {
      font-size: 1.18em;
      font-weight: 600;
      color: #0e3f8f;
      margin-bottom: 8px;
    }
    .popup-thank .btn-back {
      margin-top: 12px;
      padding: 7px 20px;
      background: #03a9f4;
      color: #fff;
      border: none;
      border-radius: 7px;
      cursor: pointer;
    }
    .new-staff-row { background: #f0f8ff !important; }
    .original-staff-label {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }
    .delete-staff-btn {
      background: #e53935;
      color: #fff;
      border: none;
      min-width: 48px;
      min-height: 26px;
      padding: 4px 10px;
      font-size: 0.96em;
      border-radius: 4px;
      font-weight: 600;
      margin: 0 auto;
      display: block;
      transition: background 0.18s;
    }
    .delete-staff-btn:hover {
      background: #c62828;
    }
    .staff-action-select {
      width: 140px;
      min-width: 75px;
      height: 28px;
      font-size: 0.9em;
      padding: 1px 6px;
      border-radius: 4px;
      border: 1px solid #736c6c;
      box-sizing: border-box;
      text-align: center;
      font-weight: 600;
      transition: color 0.2s;
    }
    @media (max-width: 600px) {
    .modal-dialog { max-width: 99vw !important; min-width: 0; }
    .modal-content {
    width: 95vw !important;
    max-width: 98vw !important;
    margin: 0 auto !important;
    max-height: calc(100vh - 40px) !important;
    overflow-y: auto !important;
    box-sizing: border-box;
  }
      .staff-list-table th, .staff-list-table td { font-size: 0.92em; padding: 1px 0; }
      .staff-action-select { width: 55px; font-size: 0.93em; height: 22px; }
      .delete-staff-btn { min-width: 34px; min-height: 19px; font-size: 0.91em; }
      .mobile-navbar {
        position: relative;
        display: flex !important;
        align-items: center;
        width: 100vw;
        background: #228B22;
        min-height: 54px;
        height: 54px;
        z-index: 10001;
      }
      .mobile-navbar .hamburger {
        padding: 12px 12px 12px 7px;
        font-size: 27px;
        color: #fff;
        background: none;
        border: none;
        outline: none;
        margin-right: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      .mobile-navbar .navbar-title {
        flex: 1 1 70%;
        display: flex;
        flex-direction: column;
        min-width: 0;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        padding-right: 0;
      }
      .mobile-navbar .navbar-title .brand-main {
        color: #e1ba0a;
        font-weight: bold;
        font-size: 1.13em;
        line-height: 1.1;
        margin-bottom: 0;
      }
      .mobile-navbar .navbar-title .brand-sub {
        color: #e1ba0a;
        font-weight: bold;
        font-size: 0.99em;
        line-height: 1;
        margin-top: 0;
      }
      .mobile-navbar .mobile-hotline {
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 30px;
        padding: 3px 16px 3px 11px;
        box-shadow: 0 0 5px #1113;
        height: 28px;
        font-size: 0.98em;
        white-space: nowrap;
        overflow: hidden;
        text-decoration: none !important;
      }
      .mobile-navbar .mobile-hotline .hotline-number {
        font-size: 1.07em;
        margin-left: 3px;
        font-weight: bold;
        color: #0011ff;
        letter-spacing: 0.5px;
        text-decoration: none !important;
      }
      .mobile-navbar .mobile-hotline:link,
      .mobile-navbar .mobile-hotline:visited,
      .mobile-navbar .mobile-hotline:hover,
      .mobile-navbar .mobile-hotline:active {
        text-decoration: none !important;
      }
  .mobile-navbar-menu {
  display: none;
  position: fixed;
  top: 54px;
  left: 0;
  min-width: 180px;
  width: max-content;
  max-width: 92vw;
  background: #228B22;
  color: #fff;
  z-index: 12000;
  box-shadow: 2px 0 10px rgba(0,0,0,0.13);
  border-radius: 0 0 10px 0;
  padding: 0 0 16px 0;
  animation: slideInMenu 0.18s;
}
      .mobile-navbar-menu.open { display: block; }
      @keyframes slideInMenu {
        from { transform: translateX(-90%); opacity: 0.5; }
        to { transform: translateX(0); opacity: 1; }
      }
      .mobile-navbar-menu ul {
        list-style: none;
        margin: 0;
        padding: 10px 0 0 0;
      }
      .mobile-navbar-menu li {
        padding: 13px 0 9px 18px;
        font-size: 1.12em;
        cursor: pointer;
        font-weight: bold;
        border-bottom: 1px solid rgba(255,255,255,0.10);
        transition: background 0.1s;
      }
      .mobile-navbar-menu li:active,
      .mobile-navbar-menu li:hover {
        background: #1c6e1b;
      }
      .mobile-navbar-menu li:last-child { border-bottom: none; }
      .container {
        padding: 7px 2vw 10px 2vw !important;
        border-radius: 0;
        max-width: 100vw;
        margin: 12px auto 0;
        box-shadow: none;
      }
      #footer-container {
        min-height: 54px;
        height: 54px;
        font-size: 0.98em;
        padding: 0 7px;
        line-height: 1.15;
      }
      #footer-container div {
        width: 100%;
        text-align: center;
        line-height: 1.15;
        word-break: break-word;
      }
    }
    @media (max-width: 768px) {
      #navbar-container .desktop-navbar {
        display: none !important;
      }
    }
    @media (min-width: 769px) {
      .mobile-navbar, .mobile-navbar-menu { display: none !important; }
    }
  #popupLoading {
  position: absolute;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.77);
  z-index: 15000;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
}
#deleteStaffModal.modal {
  display: none;
  position: fixed;
  z-index: 13000 !important;
  left: 0; top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(60,70,80,0.18);
  /* Chỉ căn giữa khi có class show */
}
#deleteStaffModal.show {
  display: flex !important;
  align-items: center;
  justify-content: center;
}
.delete-staff-modal-dialog {
  width: 100%;
  max-width: 350px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}
.delete-staff-modal-content {
  background: #f8fafc;
  border-radius: 10px;
  box-shadow: 0 7px 28px rgba(34,60,80,0.16);
  border: 1.5px solid #cfe2e8;
  padding: 21px 20px 16px 20px;
  width: 100%;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.delete-staff-modal-title {
  font-size: 1.08em;
  font-weight: 500;
  color: #091379;
  text-align: center;
  margin-bottom: 18px;
  line-height: 1.3;
}
.delete-staff-modal-actions {
  display: flex;
  justify-content: center;
  gap: 14px;
  width: 100%;
}
.delete-staff-btn-confirm,
.delete-staff-btn-cancel {
  padding: 6px 20px;
  min-width: 0;
  font-size: 1em;
  font-weight: 600;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
  box-shadow: none;
  outline: none;
  /* Giảm chiều cao và chiều dài nút */
  min-width: 54px;
}
.delete-staff-btn-confirm {
  background: #0cac14;
  color: #fff;
}
.delete-staff-btn-confirm:hover {
  background: #189b11;
}
.delete-staff-btn-cancel {
  background: #e91b0d;
  color: #ffffff;
}
.delete-staff-btn-cancel:hover {
  background: #c50909;
  color: #ffffff;
}
@media (max-width: 520px) {
  .delete-staff-modal-content {
    padding: 14px 7px 12px 7px;
    max-width: 98vw;
  }
}
/* Thêm style cho note đỏ */
    .orders-empty-note {
      color: #e53935;
      background: #fff6f6;
      border: 1px solid #e53935;
      padding: 8px 14px;
      border-radius: 5px;
      text-align: center;
      font-size: 1.08em;
      font-weight: 600;
      margin: 0 auto 12px auto;
      max-width: 290px;
      box-shadow: 0 1px 5px rgba(229,57,53,0.08);
    }
    @media (min-width: 601px) {
  #mobileOrdersTableWrap, .mobile-orders-table {
    display: none !important;
  }
}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div id="navbar-container">
    <!-- Mobile Navbar -->
    <div class="mobile-navbar">
      <button class="hamburger" id="hamburgerBtn" aria-label="Mở menu" tabindex="0">
        <i class="fa fa-bars"></i>
      </button>
      <a href="index.html" class="navbar-title" id="navbarTitleLink" style="text-decoration:none;">
        <span class="brand-main">Coffee & Beer</span>
        <span class="brand-sub">DJ GooDjn</span>
      </a>
      <a class="mobile-hotline" href="tel:0902926636">
        <i class="fa-solid fa-phone" style="color:#e53935"></i>
        <span class="hotline-number">0902 926 636</span>
      </a>
    </div>
    <nav class="mobile-navbar-menu" id="mobileMenu">
      <ul>
        <li data-href="index.html">Đặt dịch vụ</li>
        <li data-href="danhgiakh.html">Đánh giá dịch vụ</li>
        <li data-href="Baocao.html">Báo cáo</li>
        <li id="mobileLogoutTab" style="display:none;">Đăng xuất</li>
      </ul>
    </nav>
    <!-- Desktop Navbar (tải động qua JS) -->
    <div class="desktop-navbar"></div>
  </div>
  <div class="site-content">
    <div class="container">
    <button id="wake-btn" class="wake-btn-absolute" title="Làm mới dữ liệu">
    <i class="fa fa-bolt"></i> Đánh thức
    </button>
      <h2>DANH SÁCH ĐƠN HÀNG TRONG 24H</h2>
      <div id="ordersEmptyNote" style="display:none;"></div>
      <div class="table-actions">
        <div style="display:flex;align-items:center;gap:4px;">
          <label for="entriesSelect" style="font-size:14px;">Show</label>
          <select id="entriesSelect" class="entries-select">
            <option>10</option><option>20</option><option>50</option><option>100</option>
          </select>
          <span style="font-size:14px;">entries</span>
        </div>
        <div class="search-box">
          <input type="text" id="filterInput" placeholder="Nhập từ khóa tìm kiếm">
        </div>
      </div>
      <div class="orders-table-wrap">
        <!-- TABLE DESKTOP -->
        <table class="orders-table" id="ordersTable">
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Mã đơn hàng</th>
              <th>Tên khách hàng</th>
              <th>Số điện thoại</th>
              <th>Địa chỉ email</th>
              <th>Khách ghi chú</th>
              <th>Số thẻ bàn</th>
              <th>Mã NV</th>
              <th>Tổng tiền</th>
              <th>Xác nhận đơn hàng</th>
              <th>Quản lý ghi chú</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody"></tbody>
        </table>
        <!-- TABLE MOBILE DYNAMIC -->
        <div id="mobileOrdersTableWrap" style="display:none;"></div>
      </div>
      <div class="table-pagination" id="tablePagination"></div>
    </div>
    <!-- Popup xác nhận/hủy -->
    <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
      <div class="modal-dialog mt-4">
        <div class="modal-content">
        <div id="popupLoading" style="display:none; position:absolute; left:0; top:0; right:0; bottom:0; background:rgba(255,255,255,0.77); z-index:15000; align-items:center; justify-content:center; border-radius:10px;">
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
        <i class="fa fa-spinner fa-spin" style="font-size:2.1em;color:#1976d2;"></i>
        <span style="font-size:1.12em; color:#1976d2; font-weight:bold;">Đang gửi...</span>
        </div>
        </div>
          <div class="modal-header">
            <h5 class="modal-title" id="orderModalLabel">THÔNG TIN ĐƠN HÀNG</h5>
            <button type="button" class="close" onclick="closeOrderModal()" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div style="text-align:center;color:#16a800;font-size:1.08em;margin-bottom:10px">
              Mã đơn hàng: <span id="modalOrderId"></span>
            </div>
            <div class="order-info-row">
              <label for="modalTenKH">Tên khách hàng:</label>
              <input id="modalTenKH" readonly>
            </div>
            <div class="order-info-row">
              <label for="modalSDT">Số điện thoại:</label>
              <input id="modalSDT" readonly>
            </div>
            <div class="order-info-row">
              <label for="modalEmail">Địa chỉ Email:</label>
              <input id="modalEmail" readonly>
            </div>
            <div class="order-info-row">
              <label for="modalTable">Số thẻ bàn:</label>
              <input id="modalTable">
            </div>
            <div class="order-info-row">
            <label for="modalNote">Ghi chú:</label>
            <input id="modalNote">
            </div>
            <label class="section-title">1. Nhân viên phục vụ</label>
            <div class="staff-both-btns">
              <button class="btn-tatca" onclick="modalTatCaDongY()">Tất cả đồng ý</button>
              <button class="btn-huydon" onclick="modalHuyDon()">Hủy đơn</button>
              <button class="btn-them-nv" onclick="modalThemNhanVien()">+ Thêm NV</button>
            </div>
            <table class="staff-list-table" id="modalStaffTable">
              <thead>
                <tr>
                  <th>Mã NV</th>
                  <th>Ca LV</th>
                  <th>Đơn giá</th>
                  <th>Thực hiện đơn hàng</th>
                  <th>Trạng thái</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="2" style="text-align:right;font-weight:bold;color:#0b4fd7;">Tổng cộng</td>
                  <td id="staffTotal" style="font-weight:bold;color:#e53935;text-align:center;"></td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
            <label for="modalGhiChu" class="section-title">2. Quản lý ghi chú</label>
            <textarea class="ql-ghichu-input" id="modalGhiChu" placeholder="Nhập ghi chú quản lý..."></textarea>
            <div class="modal-footer">
              <button class="btn-popup-xacnhan" onclick="modalSubmitXacNhan()">Xác nhận</button>
              <button class="btn-popup-close" onclick="closeOrderModal()">Đóng</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Popup xác nhận xóa nhân viên -->
    <div class="modal" id="deleteStaffModal" tabindex="-1" aria-hidden="true">
      <div class="delete-staff-modal-dialog">
        <div class="delete-staff-modal-content">
          <div class="delete-staff-modal-title">
            Bạn có chắc muốn xóa nhân viên này không?
          </div>
          <div class="delete-staff-modal-actions">
            <button id="confirmDeleteStaffBtn" class="delete-staff-btn-confirm" type="button">Có</button>
            <button id="cancelDeleteStaffBtn" class="delete-staff-btn-cancel" type="button">Không</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Popup cảm ơn -->
    <div class="modal fade" id="thankModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="popup-thank" role="alert">
          <div class="title" id="thankMsg">Đơn hàng đã được xử lý!</div>
          <div>Cảm ơn bạn đã sử dụng hệ thống quản lý.</div>
          <button class="btn-back" onclick="closeThankPopup()">Quay lại</button>
        </div>
      </div>
    </div>
  </div>
  <!-- FOOTER -->
  <div id="footer-container">
    <div>
      © 2025 Coffee & Beer DJ GooDjn. All rights reserved.<br>
      63-65 Ngô Quyền, Phường 6, Quận 10, Hồ Chí Minh
    </div>
  </div>
  <!-- SCRIPT ĐĂNG NHẬP VÀ NAVBAR -->
  <script>
    // Kiểm tra đăng nhập, nếu chưa sẽ chuyển về login.html
   if(localStorage.getItem('isAdmin') !== '1') window.location.replace('login.html');

    // Hàm hiện/ẩn tab Đăng xuất cả desktop và mobile
    function showLogoutTabIfLoggedIn() {
      var logoutTab = document.getElementById('logoutTab');
      var mobileLogoutTab = document.getElementById('mobileLogoutTab');
      if(localStorage.getItem('isAdmin') === '1') {
        if (logoutTab) logoutTab.style.display = '';
        if (mobileLogoutTab) mobileLogoutTab.style.display = '';
      } else {
        if (logoutTab) logoutTab.style.display = 'none';
        if (mobileLogoutTab) mobileLogoutTab.style.display = 'none';
      }
    }
    // Hàm đăng xuất
function logout() {
  localStorage.removeItem('isAdmin');
  localStorage.removeItem('isLoggedIn');
  clearAllCookies();
  window.location.replace('login.html');
}
    // Tải navbar.html vào desktop-navbar (ẩn trên mobile)
    fetch('navbar.html')
      .then(response => response.text())
      .then(html => {
        document.querySelector('#navbar-container .desktop-navbar').innerHTML = html;
        showLogoutTabIfLoggedIn();
         // Chỉ hiện tab Báo cáo trên trang quản lý
    var baocaoTab = document.querySelector('.tab-baocao');
    if (baocaoTab) baocaoTab.style.display = '';
      });

    // Xử lý menu mobile
    document.addEventListener('DOMContentLoaded', function(){
      var hamburger = document.getElementById('hamburgerBtn');
      var menu = document.getElementById('mobileMenu');
      document.addEventListener('click', function(e){
        if (menu.classList.contains('open') && !menu.contains(e.target) && !hamburger.contains(e.target)) {
          menu.classList.remove('open');
        }
      });
      hamburger.onclick = function(e){
        e.stopPropagation();
        menu.classList.toggle('open');
      };
      menu.querySelectorAll('li[data-href]').forEach(function(tab){
        tab.onclick = function(){
          menu.classList.remove('open');
          window.location.href = tab.getAttribute('data-href');
        };
      });
      // Gắn sự kiện cho nút Đăng xuất trên mobile
      var mobileLogoutTab = document.getElementById('mobileLogoutTab');
      if(mobileLogoutTab) {
        mobileLogoutTab.onclick = function() { logout(); };
      }
      showLogoutTabIfLoggedIn();
    });

    // Footer auto-hide on mobile input focus (bàn phím ảo)
    (function(){
      function hideFooter() {
        var f = document.getElementById('footer-container');
        if(f) f.style.display = 'none';
      }
      function showFooter() {
        var f = document.getElementById('footer-container');
        if(f) f.style.display = '';
      }
      document.addEventListener('DOMContentLoaded', function() {
        if(!isMobile()) return;
        var inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(function(el) {
          el.addEventListener('focus', hideFooter);
          el.addEventListener('blur', showFooter);
        });
        var oldHeight = window.innerHeight;
        window.addEventListener('resize', function() {
          if(!isMobile()) return;
          if(window.innerHeight < oldHeight - 80) hideFooter();
          else showFooter();
          oldHeight = window.innerHeight;
        });
      });
    })();
  </script>
  <script>
        // ========== MAIN LOGIC ========== 
    let PRODUCT_STAFFS = [];
    let PRODUCT_STAFFS_ALL = [];
    const ENTRIES_OPTIONS = [10,20,50,100];
    let ORDERS = [];
    let FILTERED = [];
    let page = 1, entries = 10, totalPages = 1;
    let modalOrder = null, modalOrderIndex = -1, modalStaffs = [], modalStatus = '';
    let modalHasNewStaff = false;
    // ==== BỔ SUNG NGAY SAU ĐÂY ====
function isMobile() {
  return window.innerWidth <= 600;
}

function renderCurrentTable() {
  if (isMobile()) {
    renderMobileOrdersTable();
  } else {
    renderTable();
  }
}
    async function fetchProductStaffs() {
  try {
    const res = await fetch('/api/orderquanly?products=1');
    const data = await res.json();
    PRODUCT_STAFFS = data.products || [];
    // Thêm dòng này để lấy TẤT CẢ không lọc
    PRODUCT_STAFFS_ALL = (data.products_all || PRODUCT_STAFFS); // sửa API nếu muốn trả về đầy đủ
  } catch (error) {
    PRODUCT_STAFFS = [];
    PRODUCT_STAFFS_ALL = [];
  }
}
    async function fetchProductStaffsAll() {
  try {
    const res = await fetch('/api/orderquanly?productsAll=1');
    const data = await res.json();
    PRODUCT_STAFFS_ALL = data.products || [];
  } catch (error) {
    PRODUCT_STAFFS_ALL = [];
  }
}

    async function fetchOrders() {
      try {
        const res = await fetch('/api/orderquanly');
        const data = await res.json();
        ORDERS = (data.orders || []).map((o, idx) => ({ ...o, _index: idx }));
      } catch (error) {
        ORDERS = [];
      }
    }
    // Phân trang và filter tối ưu
function filterTable() {
  const kw = document.getElementById("filterInput").value.trim().toLowerCase();
  FILTERED = ORDERS.filter(o =>
    o.time.toLowerCase().includes(kw) ||
    o.orderId.toLowerCase().includes(kw) ||
    o.name.toLowerCase().includes(kw) ||
    o.phone.toLowerCase().includes(kw) ||
    o.email.toLowerCase().includes(kw) ||
    o.note.toLowerCase().includes(kw) ||
    o.table.toLowerCase().includes(kw) ||
    o.staffList.map(s => s.maNV).join(", ").toLowerCase().includes(kw) ||
    o.total.toLowerCase().includes(kw) ||
    (o.qlNote || "").toLowerCase().includes(kw)
  );
  page = 1;
  renderCurrentTable();
}

function renderTable() {
  // Chỉ render đúng số dòng trên trang hiện tại (desktop)
  const start = (page - 1) * entries;
  const end = start + entries;
  const paged = FILTERED.slice(start, end);

  let html = paged.map(o => {
    let maNVs = o.staffList.map(s => s.maNV).join(", ");
    let btn = "";
    if (o.confirmStatus === "chuaxacnhan") btn = `<button class="btn-confirm" onclick="openOrderModal(${o._index})">Xác nhận</button>`;
    else if (o.confirmStatus === "daxacnhan") btn = `<button class="btn-daxacnhan" onclick="openOrderModal(${o._index})">Đã xác nhận</button>`;
    else if (o.confirmStatus === "huydon") btn = `<button class="btn-huy" disabled>Hủy đơn</button>`;
    return `<tr>
      <td>${o.time}</td>
      <td>${o.orderId}</td>
      <td>${o.name}</td>
      <td>${o.phone}</td>
      <td>${o.email}</td>
      <td>${o.note}</td>
      <td>${o.table}</td>
      <td>${maNVs}</td>
      <td>${o.total}</td>
      <td>${btn}</td>
      <td class="ql-ghichu-box">${o.qlNote || ""}</td>
    </tr>`;
  }).join("");

  document.getElementById("ordersTableBody").innerHTML = html;
  renderPagination();
}
// // Mobile table: vẫn chỉ render số dòng trên trang hiện tại
function renderMobileOrdersTable() {
  // Chỉ render bảng mobile nếu là mobile
  if (!isMobile()) {
    document.getElementById("mobileOrdersTableWrap").style.display = "none";
    return;
  }
  let head = `<div class="mobile-orders-table-head">
    <div class="col col-khach">Tên khách hàng</div>
    <div class="col col-ban">Số thẻ bàn</div>
    <div class="col col-mnv">Mã NV</div>
    <div class="col col-tong">Tổng tiền</div>
    <div class="col col-xacnhan">Xác nhận<br>đơn hàng</div>
  </div>`;
  const start = (page - 1) * entries, end = start + entries;
  const paged = FILTERED.slice(start, end);
  let rows = paged.map(o => {
    let maNVs = o.staffList.map(s => s.maNV).join(", ");
    let btn = "";
    if (o.confirmStatus === "chuaxacnhan")
      btn = `<button class="btn-confirm" style="width:72px;min-width:62px;" onclick="openOrderModal(${o._index})">Xác nhận</button>`;
    else if (o.confirmStatus === "daxacnhan")
      btn = `<button class="btn-daxacnhan" style="width:72px;min-width:62px;" onclick="openOrderModal(${o._index})">Đã xác nhận</button>`;
    else if (o.confirmStatus === "huydon")
      btn = `<button class="btn-huy" style="width:72px;min-width:62px;" disabled>Hủy đơn</button>`;
    return `<div class="mobile-orders-table-row">
      <div class="col col-khach">${o.name}</div>
      <div class="col col-ban">${o.table}</div>
      <div class="col col-mnv">${maNVs}</div>
      <div class="col col-tong">${parseInt(o.total || 0).toLocaleString('vi-VN')}</div>
      <div class="col col-xacnhan">${btn}</div>
    </div>`;
  }).join('');
  document.getElementById("mobileOrdersTableWrap").innerHTML = `<div class="mobile-orders-table">${head}${rows}</div>`;
  document.getElementById("mobileOrdersTableWrap").style.display = "";
    // THÊM DÒNG NÀY:
  renderPagination();
}
    // Phân trang tối ưu: chỉ hiển thị đúng số nút cần thiết
  function renderPagination() {
  if (FILTERED.length === 0) {
    document.getElementById("tablePagination").innerHTML = "";
    return;
  }
  totalPages = Math.ceil(FILTERED.length / entries);
  let html = "";

  html += `<button ${page === 1 ? "disabled" : ""} onclick="gotoPage(${Math.max(1, page - 1)})">Previous</button>`;
  let startPage = Math.max(1, page - 2);
  let endPage = Math.min(totalPages, page + 2);
  if (startPage > 1) html += `<button onclick="gotoPage(1)">1</button><span>...</span>`;
  for (let p = startPage; p <= endPage; p++) {
    html += `<button ${p === page ? "class='active' disabled" : ""} onclick="gotoPage(${p})">${p}</button>`;
  }
  if (endPage < totalPages) html += `<span>...</span><button onclick="gotoPage(${totalPages})">${totalPages}</button>`;
  html += `<button ${page === totalPages ? "disabled" : ""} onclick="gotoPage(${Math.min(totalPages, page + 1)})">Next</button>`;

  document.getElementById("tablePagination").innerHTML = html;
}

function gotoPage(p) {
  page = Math.max(1, Math.min(totalPages, p));
  renderCurrentTable();
}

    // ========== UI EVENTS ==========
  // Khởi tạo: chỉ sort 1 lần sau khi fetch, KHÔNG sort lại mỗi lần render/filter
document.addEventListener("DOMContentLoaded", async () => {
  await fetchProductStaffs();
  await fetchProductStaffsAll();
  await fetchOrders();
  ORDERS.sort((a, b) => new Date(b.time) - new Date(a.time));
  FILTERED = ORDERS.slice();
  document.getElementById("entriesSelect").addEventListener("change", function () {
    entries = parseInt(this.value) || 10;
    page = 1;
    renderCurrentTable();
  });
  document.getElementById("filterInput").addEventListener("input", filterTable);
  renderCurrentTable();
  window.addEventListener('resize', renderCurrentTable);
});
    // ========== POPUP/FORM LOGIC ==========
    function openOrderModal(idx) {
      // Reset lại trạng thái enabled cho nút "Xác nhận" và "Đóng"
      document.querySelector('.btn-popup-xacnhan').disabled = false;
      document.querySelector('.btn-popup-close').disabled = false;
      modalOrderIndex = idx;
      modalOrder = {...ORDERS[idx]};
      modalStaffs = modalOrder.staffList.map(s=>({
  ...s,
  isOriginal: true,
  donGia: parseInt(s.donGia||0),
  donGiaOrigin: parseInt(s.donGia||0),
  trangThai: s.trangThai || "Đồng ý",
  trangThaiOrigin: s.trangThai || "Đồng ý" // Thêm dòng này
}));

      modalStatus = "chuaxacnhan";
      modalHasNewStaff = false;
      document.getElementById("modalOrderId").textContent = modalOrder.orderId;
      document.getElementById("modalTenKH").value = modalOrder.name;
      document.getElementById("modalSDT").value = modalOrder.phone;
      document.getElementById("modalEmail").value = modalOrder.email;
      document.getElementById("modalTable").value = modalOrder.table;
      document.getElementById("modalNote").value = modalOrder.note;
      document.getElementById("modalGhiChu").value = modalOrder.qlNote || "";
      renderModalStaffTable();
      document.body.style.overflow = "hidden";
      document.getElementById("orderModal").classList.add("show");
      document.getElementById("orderModal").style.display = "block";
    }
    function closeOrderModal() {
      document.body.style.overflow = "";
      document.getElementById("orderModal").classList.remove("show");
      document.getElementById("orderModal").style.display = "none";
    }
    
function renderModalStaffTable() {
  let html = "";
  let total = 0;
  modalStaffs.forEach((s, i) => {
    let donGiaShow = (s.trangThai === "Hủy đơn" || s.trangThai === "Không tham gia") ? 0 : parseInt(s.donGia || 0);
    if (donGiaShow > 0) total += donGiaShow;
    const deleteBtn = s.isOriginal
      ? `<span class="original-staff-label">Nhân viên gốc</span>`
      : `<button class="delete-staff-btn" onclick="modalXoaNhanVien(${i})">Xóa</button>`;
    const rowClass = s.isOriginal ? '' : 'new-staff-row';
    html += `<tr class="${rowClass}">`;

    // ======= Cột Mã NV =======
    if (s.isOriginal) {
      html += `<td>
        <input type="text" value="${s.maNV || ''}" readonly style="width:65px;text-align:center;font-size:0.96em;border:none;background:transparent;">
      </td>`;
    } else {
      html += `<td>
        <input type="text" value="${s.maNV || ''}" 
          style="width:65px;text-align:center;font-size:0.96em;" 
          list="availableNVs" autocomplete="off" inputmode="text" autocapitalize="off" spellcheck="false"
          onclick="this.select()" onfocus="this.select()"
          onchange="modalChangeMaNV(${i},this.value)">
      </td>`;
    }

    // Các cột khác giữ nguyên...
    html += `<td>
      <input type="text" value="${s.caLV || ''}" readonly style="width:30px;text-align:center;font-size:0.96em;border:none;background:transparent;">
    </td>`;
    html += `<td>
      <input type="text" value="${donGiaShow.toLocaleString('vi-VN')}" readonly style="width:60px;border:none;text-align:right;background:transparent;font-weight:bold;color:#0b8e0b;font-size:0.96em;">
    </td>`;
    html += `<td>
      <select class="staff-action-select" onchange="modalStaffChange(${i},this)">
        <option value="Đồng ý"${s.trangThai === "Đồng ý" ? " selected" : ""}>Đồng ý</option>
        <option value="Không tham gia"${s.trangThai === "Không tham gia" ? " selected" : ""}>Không tham gia</option>
        <option value="Hủy đơn"${s.trangThai === "Hủy đơn" ? " selected" : ""}>Hủy đơn</option>
      </select>
    </td>`;
    html += `<td>${deleteBtn}</td></tr>`;
  });

  document.querySelector("#modalStaffTable tbody").innerHTML = html;
  document.getElementById("staffTotal").innerText = total.toLocaleString('vi-VN');
  renderDatalistMaNV();
  setAllDropdownColors();
}
    function modalGetCaOptions(maNV, caLV) {
      const cas = PRODUCT_STAFFS.filter(x=>x.maNV===maNV).map(x=>x.caLV);
      let uniqueCas = [...new Set(cas)];
      return uniqueCas.map(ca=>
        `<option value="${ca}"${ca==caLV?' selected':''}>${ca}</option>`
      ).join('');
    }
    // Datalist cho input mã NV khi thêm mới
    function renderDatalistMaNV() {
  let html = '<datalist id="availableNVs">';
  PRODUCT_STAFFS.forEach(p => {
    html += `<option value="${p.maNV} - Ca ${p.caLV} - ${parseInt(p.donGia).toLocaleString('vi-VN')} VNĐ"></option>`;
  });
  html += '</datalist>';
  if (!document.getElementById('availableNVs')) {
    let el = document.createElement('div');
    el.innerHTML = html;
    document.body.appendChild(el.firstChild);
  } else {
    document.getElementById('availableNVs').outerHTML = html;
  }
}
    // Khi đổi mã NV ở dòng mới
 function modalChangeMaNV(i, val) {
  // Format: MS04 - Ca 2 - 150.000 VNĐ
  const regex = /^(.+?)\s*-\s*Ca\s*(\d+)\s*-\s*([\d.,]+)\s*VNĐ$/;
  const match = val.match(regex);
  if (match) {
    modalStaffs[i].maNV = match[1].trim();
    modalStaffs[i].caLV = match[2].trim();
    modalStaffs[i].donGia = parseInt(match[3].replace(/[.,]/g, ''));
    modalStaffs[i].donGiaOrigin = parseInt(match[3].replace(/[.,]/g, ''));
    modalStaffs[i].trangThai = "Đồng ý";
    modalHasNewStaff = true;
    renderModalStaffTable();
    return;
  }
  // Nếu người dùng nhập tay không đúng format => reset caLV, donGia
  modalStaffs[i].maNV = val.trim();
  modalStaffs[i].caLV = '';
  modalStaffs[i].donGia = 0;
  modalStaffs[i].donGiaOrigin = 0;
  renderModalStaffTable();
}
    // Khi đổi ca LV ở dòng mới
    function modalChangeCaLV(i, val) {
      let found = PRODUCT_STAFFS.find(x=>x.maNV===modalStaffs[i].maNV && x.caLV==val);
      if (found) {
        modalStaffs[i].caLV = val;
        modalStaffs[i].donGia = parseInt(found.donGia||0);
        modalStaffs[i].donGiaOrigin = parseInt(found.donGia||0);
        modalHasNewStaff = true;
      }
      renderModalStaffTable();
    }

    // === CẬP NHẬT ĐƠN GIÁ KHI ĐỔI TRẠNG THÁI NHÂN VIÊN ===
function modalStaffChange(i, sel) {
  let staff = modalStaffs[i];
  staff.trangThai = sel.value;

  if (sel.value === "Hủy đơn" || sel.value === "Không tham gia") {
    staff.donGia = 0;
  } else if (sel.value === "Đồng ý") {
    if (staff.isOriginal) {
      // Nếu trạng thái gốc là “Không tham gia” hoặc “Hủy đơn” thì lấy giá từ Products (ALL), còn lại giữ đơn giá gốc
      if (staff.trangThaiOrigin === "Không tham gia" || staff.trangThaiOrigin === "Hủy đơn") {
        // Lấy đơn giá từ Products sheet KHÔNG filter điều kiện gì ngoài mã NV và ca LV
        let found = PRODUCT_STAFFS_ALL.find(x =>
          String(x.maNV).trim() === String(staff.maNV).trim() &&
          String(x.caLV).trim() === String(staff.caLV).trim()
        );
        staff.donGia = found ? parseInt(found.donGia || 0) : 0;
      } else {
        // Trạng thái gốc là Đồng ý, lấy lại giá gốc từ đơn Orders
        staff.donGia = staff.donGiaOrigin;
      }
    } else {
      // Nhân viên mới vẫn giữ nguyên điều kiện filter như trước
      let found = PRODUCT_STAFFS.find(x =>
        String(x.maNV).trim() === String(staff.maNV).trim() &&
        String(x.caLV).trim() === String(staff.caLV).trim() &&
        String(x.status).trim() === "Làm việc" &&
        (!x.lockStatus || String(x.lockStatus).trim() === "")
      );
      staff.donGia = found ? parseInt(found.donGia || 0) : 0;
    }
  }
  renderModalStaffTable();
}
  function modalTatCaDongY() {
  modalStaffs.forEach((s, i) => {
    const prevTrangThai = s.trangThai;
    s.trangThai = "Đồng ý";
    if (s.isOriginal) {
      // Nếu trước đó là Không tham gia/Hủy đơn, lấy đơn giá từ Products ALL (không lọc điều kiện gì)
      if (prevTrangThai === "Không tham gia" || prevTrangThai === "Hủy đơn") {
        let found = PRODUCT_STAFFS_ALL.find(x =>
          String(x.maNV).trim() === String(s.maNV).trim() &&
          String(x.caLV).trim() === String(s.caLV).trim()
        );
        s.donGia = found ? parseInt(found.donGia || 0) : 0;
      } else {
        // Nếu trạng thái cũ đã là Đồng ý, giữ nguyên đơn giá cũ trong Orders
        // hoặc nếu muốn, có thể set về đơn giá cũ gốc trong Orders:
        s.donGia = s.donGiaOrigin;
      }
    } else {
      // Nhân viên mới vẫn giữ nguyên điều kiện (Làm việc & không khóa)
      let found = PRODUCT_STAFFS.find(x =>
        String(x.maNV).trim() === String(s.maNV).trim() &&
        String(x.caLV).trim() === String(s.caLV).trim() &&
        String(x.status).trim() === "Làm việc" &&
        (!x.lockStatus || String(x.lockStatus).trim() === "")
      );
      s.donGia = found ? parseInt(found.donGia || 0) : 0;
    }
  });
  renderModalStaffTable();
}

    function modalHuyDon() {
      modalStatus = "huydon";
      modalStaffs.forEach(s=>{
        s.trangThai="Hủy đơn";
        s.donGia=0;
      });
      renderModalStaffTable();
    }
    function modalThemNhanVien() {
      let available = PRODUCT_STAFFS.filter(s =>
        s.status === "Làm việc" && (!s.lockStatus || s.lockStatus.trim() === "")
      );
      if (!available.length) {
        alert("Không có nhân viên khả dụng.");
        return;
      }
      modalHasNewStaff = true;
      modalStaffs.push({
        maNV:"",
        caLV:"",
        donGia:0,
        donGiaOrigin:0,
        trangThai:"Đồng ý",
        isOriginal: false
      });
      renderModalStaffTable();
    }
    
let pendingDeleteStaffIndex = null;
function modalXoaNhanVien(index) {
  if(modalStaffs[index].isOriginal) {
    alert('Không thể xóa nhân viên gốc!');
    return;
  }
  modalHasNewStaff = true;
  pendingDeleteStaffIndex = index;
  document.getElementById('deleteStaffModal').classList.add('show');
}

document.getElementById('confirmDeleteStaffBtn').onclick = function() {
  if(pendingDeleteStaffIndex !== null) {
    modalStaffs.splice(pendingDeleteStaffIndex, 1);
    renderModalStaffTable();
    pendingDeleteStaffIndex = null;
  }
  document.getElementById('deleteStaffModal').classList.remove('show');
};

document.getElementById('cancelDeleteStaffBtn').onclick = function() {
  pendingDeleteStaffIndex = null;
  document.getElementById('deleteStaffModal').classList.remove('show');
};
    // ================== QUAN TRỌNG: HÀM SUBMIT XÁC NHẬN ĐƠN HÀNG ======================
  async function modalSubmitXacNhan() {
  if (modalOrderIndex < 0) return;
  const btnXacNhan = document.querySelector('.btn-popup-xacnhan');
  const btnClose = document.querySelector('.btn-popup-close');
  const popupLoading = document.getElementById('popupLoading');
  btnXacNhan.disabled = true;
  btnClose.disabled = true;
  popupLoading.style.display = 'flex';
  try {
        let tongcong = 0;
        let staffListSend = [];
        modalStaffs.forEach(s=>{
          let trangThai = s.trangThai || "Đồng ý";
          let donGia = (trangThai==="Đồng ý") ? (parseInt(s.donGia)||0) : 0;
          staffListSend.push({
            maNV: s.maNV,
            caLV: s.caLV,
            donGia: donGia,
            trangThai: trangThai,
            isOriginal: s.isOriginal
          });
          if (donGia>0) tongcong += donGia;
        });
        let data = {
          orderId: modalOrder.orderId,
          staffList: staffListSend,
          ghiChu: document.getElementById("modalGhiChu").value.trim(),
          huydon: modalStatus==="huydon",
          tongcong: tongcong,
          name: document.getElementById("modalTenKH").value.trim(),
          phone: document.getElementById("modalSDT").value.trim(),
          email: document.getElementById("modalEmail").value.trim(),
          table: document.getElementById("modalTable").value.trim(),
          note: document.getElementById("modalNote").value.trim(),
        };
   const response = await fetch('/api/orderquanly', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('API call failed');
    closeOrderModal();
    await fetchOrders();
    filterTable();
    renderTable();
    openThankPopup(modalStatus === "huydon" ? "Hủy đơn thành công!" : "Xác nhận đơn hàng thành công!");
  } catch (error) {
    alert('Có lỗi xảy ra khi xử lý đơn hàng. Vui lòng thử lại.');
    btnXacNhan.disabled = false;
    btnClose.disabled = false;
  } finally {
    popupLoading.style.display = 'none';
  }
}
    // ================== END SUBMIT ======================
    function openThankPopup(msg) {
      document.getElementById("thankMsg").textContent = msg;
      document.getElementById("thankModal").classList.add("show");
      document.getElementById("thankModal").style.display = "block";
    }
    function closeThankPopup() {
      document.getElementById("thankModal").classList.remove("show");
      document.getElementById("thankModal").style.display = "none";
    }  

    // ĐỔI MÀU CHỮ DROPDOWN THEO GIÁ TRỊ
    function updateDropdownColor(sel) {
      if (!sel) return;
      let val = sel.value;
      sel.style.color =
        val === "Đồng ý" ? "#16c924"
        : val === "Không tham gia" ? "#0074d9"
        : val === "Hủy đơn" ? "#e53935"
        : "#23272f";
    }
    function setAllDropdownColors() {
      document.querySelectorAll('.staff-action-select').forEach(updateDropdownColor);
    }
    document.addEventListener("DOMContentLoaded", setAllDropdownColors);
    document.addEventListener("change", function(e){
      if(e.target.classList.contains("staff-action-select")) {
        updateDropdownColor(e.target);
      }
    });
// ================== AUTO REFRESH ======================
// Chỉ tự động refresh nếu đang ở trang quản lý đơn hàng
    if (window.location.pathname.includes("quanly")) {
  setInterval(async function(){
    await fetchOrders();
    FILTERED = ORDERS.slice();
    renderCurrentTable();
  }, 0.5 * 60 * 1000);
}
  </script>
    <script>
    // Hàm gọi API và hiển thị note nếu trống
    async function checkOrdersEmptyNote() {
      try {
        // Gọi API lấy danh sách đơn hàng (giữ đúng endpoint code backend)
        const res = await fetch('/api/orderquanly', { method: 'GET' });
        const data = await res.json();
        const orders = Array.isArray(data.orders) ? data.orders : [];
        const ordersEmptyNote = document.getElementById('ordersEmptyNote');
        if (orders.length === 0) {
          ordersEmptyNote.style.display = 'block';
          ordersEmptyNote.innerHTML = 'Danh sách trống, không có đơn hàng';
          ordersEmptyNote.className = 'orders-empty-note';
        } else {
          ordersEmptyNote.style.display = 'none';
          ordersEmptyNote.innerHTML = '';
        }
      } catch (e) {
        // Nếu lỗi vẫn không hiện note
        document.getElementById('ordersEmptyNote').style.display = 'none';
      }
    }
    // Gọi khi page load
    window.addEventListener('DOMContentLoaded', checkOrdersEmptyNote);
  </script>
  <script>
// Hàm xóa toàn bộ cookie phía client
function clearAllCookies() {
  document.cookie.split(";").forEach(function(c) {
    document.cookie = c.replace(/^ +/, "")
      .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
  });
}

// Hàm logout đầy đủ: xóa localStorage, cookie và chuyển về login
function logoutAll() {
  localStorage.removeItem('isAdmin');
  localStorage.removeItem('isLoggedIn');
  clearAllCookies();
  window.location.replace('login.html');
}

// Khi phát hiện back/forward trên history (popstate)
window.addEventListener('popstate', function(event) {
  logoutAll();
});

// Chặn truy cập khi không phải admin
if(localStorage.getItem('isAdmin') !== '1') {
  clearAllCookies();
  window.location.replace('login.html');
}
</script>
  <script>
function redirectToLogin() {
    // Xoá toàn bộ cookie phía client (nếu muốn)
    document.cookie.split(";").forEach(function(c) {
      document.cookie = c.replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    // Chuyển hướng tới trang đăng nhập (đổi đường dẫn nếu cần)
    window.location.href = "/login";
}

function checkAndLogoutAtMidnight() {
    const now = new Date();
    const tzOffset = 7 * 60; // phút cho Asia/Ho_Chi_Minh
    const local = new Date(now.getTime() + (tzOffset - now.getTimezoneOffset()) * 60000);
    const hours = local.getHours();
    const minutes = local.getMinutes();
    const seconds = local.getSeconds();

    if (hours === 0 && minutes === 0 && seconds <= 10) {
        redirectToLogin();
    }
}
setInterval(checkAndLogoutAtMidnight, 5000);
</script>
<script>
document.getElementById('wake-btn').onclick = function() {
  window.location.reload();
};
</script>
</body>
</html>
